<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control de Compras y Stock</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f9;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .container {
            display: flex;
            height: calc(100vh - 80px);
        }
        
        .sidebar {
            width: 280px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 20px 0;
        }
        
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .nav-item:hover {
            background-color: #f8f9fa;
            border-left-color: #3498db;
        }
        
        .nav-item.active {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
            color: #1976d2;
        }
        
        .nav-item i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }
        
        .module-content {
            display: none;
        }
        
        .module-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
            color: white;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .card-value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .card-subtitle {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn {
            display: inline-block;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            text-decoration: none;
            transition: all 0.3s ease;
            min-width: 80px;
            box-sizing: border-box;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Color schemes */
        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        /* Size variations */
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            min-width: 60px;
        }

        .btn-lg {
            padding: 12px 24px;
            font-size: 16px;
            min-width: 120px;
        }
        
        .data-table {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .data-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f3f4;
            word-wrap: break-word;
            max-width: 200px;
        }

        .data-table td:nth-child(6), .data-table td:nth-child(7), .data-table td:nth-child(8), .data-table td:nth-child(9) {
            max-width: 120px;
        }

        .data-table td:last-child {
            min-width: 150px;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        .row {
            display: flex;
            gap: 20px;
        }
        
        .col-2 {
            flex: 1;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            margin: 0 2px;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-muted {
            color: #6c757d;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .badge-ok { background: #28a745; color: white; }
        .badge-medio { background: #ffc107; color: black; }
        .badge-bajo { background: #dc3545; color: white; }

        .accounting-tab {
            display: none;
        }

        .accounting-tab.active {
            display: block;
        }

        /* Estilos para las abas de proveedores */
        .tab-button {
            display: inline-block;
            padding: 10px 20px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-bottom: none;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: white;
            border-color: #3498db;
            color: #3498db;
            font-weight: bold;
        }

        .tab-button:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 0 5px 5px 5px;
        }

        .tab-content.active {
            display: block;
        }

        .supplier-products-table {
            width: 100%;
            margin-top: 15px;
        }

        .supplier-products-table th,
        .supplier-products-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #f1f3f4;
        }

        .supplier-products-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .supplier-total {
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 5px;
            text-align: right;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè™ Sistema de Control de Compras y Stock</h1>
        <p>Gesti√≥n integral de proveedores, productos e inventario</p>
    </div>
    
    <div class="alert alert-success" id="alert-success"></div>
    <div class="alert alert-error" id="alert-error"></div>
    
    <div class="container">
        <div class="sidebar">
            <div class="nav-item active" onclick="showModule('dashboard')">
                <i>üìä</i>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="showModule('proveedores')">
                <i>üè¢</i>
                <span>Proveedores</span>
            </div>
            <div class="nav-item" onclick="showModule('productos')">
                <i>üì¶</i>
                <span>Productos</span>
            </div>
            <div class="nav-item" onclick="showModule('medidas')">
                <i>üìè</i>
                <span>Medidas</span>
            </div>
            <div class="nav-item" onclick="showModule('mapeos')">
                <i>üîó</i>
                <span>Mapeo Productos</span>
            </div>
            <div class="nav-item" onclick="showModule('almacenes')">
                <i>üè≠</i>
                <span>Almacenes</span>
            </div>
            <div class="nav-item" onclick="showModule('ordenes-compra')">
                <i>üìã</i>
                <span>√ìrdenes Compra</span>
            </div>
            <div class="nav-item" onclick="showModule('facturas')">
                <i>üìÑ</i>
                <span>Facturas</span>
            </div>
            <div class="nav-item" onclick="showModule('albaranes')">
                <i>üì¶</i>
                <span>Albaranes</span>
            </div>
            <div class="nav-item" onclick="showModule('stock')">
                <i>üìä</i>
                <span>Control Stock</span>
            </div>
            <div class="nav-item" onclick="showModule('configuracion')">
                <i>‚öôÔ∏è</i>
                <span>Configuraci√≥n</span>
            </div>
            <div class="nav-item" onclick="showModule('contabilidad')">
                <i>üìä</i>
                <span>Contabilidad</span>
            </div>
        </div>
        
        <div class="main-content">
            <!-- DASHBOARD MODULE -->
            <div id="dashboard" class="module-content active">
                <h2 class="section-title">Dashboard Principal</h2>
                
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon" style="background: linear-gradient(45deg, #3498db, #2980b9);">üè¢</div>
                            <div class="card-title">Proveedores</div>
                        </div>
                        <div class="card-value" id="total-proveedores">-</div>
                        <div class="card-subtitle">Total registrados</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">üì¶</div>
                            <div class="card-title">Productos</div>
                        </div>
                        <div class="card-value" id="total-productos">-</div>
                        <div class="card-subtitle">En inventario</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon" style="background: linear-gradient(45deg, #f39c12, #e67e22);">üìè</div>
                            <div class="card-title">Medidas</div>
                        </div>
                        <div class="card-value" id="total-medidas">-</div>
                        <div class="card-subtitle">Unidades definidas</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon" style="background: linear-gradient(45deg, #27ae60, #219a52);">üîó</div>
                            <div class="card-title">Mapeos</div>
                        </div>
                        <div class="card-value" id="total-mapeos">-</div>
                        <div class="card-subtitle">Productos mapeados</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon" style="background: linear-gradient(45deg, #9b59b6, #8e44ad);">üè≠</div>
                            <div class="card-title">Almacenes</div>
                        </div>
                        <div class="card-value" id="total-almacenes">-</div>
                        <div class="card-subtitle">Almacenes activos</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon" style="background: linear-gradient(45deg, #f39c12, #e67e22);">üìã</div>
                            <div class="card-title">√ìrdenes Pendientes</div>
                        </div>
                        <div class="card-value" id="ordenes-pendientes">-</div>
                        <div class="card-subtitle">√ìrdenes por procesar</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">‚ö†Ô∏è</div>
                            <div class="card-title">Stock Bajo</div>
                        </div>
                        <div class="card-value" id="productos-bajo-stock">-</div>
                        <div class="card-subtitle">Productos con stock bajo</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">üìÑ</div>
                            <div class="card-title">Facturas Pendientes</div>
                        </div>
                        <div class="card-value" id="facturas-pendientes">-</div>
                        <div class="card-subtitle">Facturas por revisar</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 style="margin-bottom: 15px;">üöÄ Estado del Sistema</h3>
                    <div id="system-status">
                        <p>Conectando al servidor...</p>
                    </div>
                </div>
            </div>
            
            <!-- PROVEEDORES MODULE -->
            <div id="proveedores" class="module-content">
                <h2 class="section-title">Gesti√≥n de Proveedores</h2>
                
                <div class="form-container">
                    <h3 style="margin-bottom: 20px;">Registrar Nuevo Proveedor</h3>
                    
                    <form id="form-proveedor">
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Nombre del Proveedor *</label>
                                    <input type="text" id="proveedor-nombre" name="nombre" required placeholder="Ej: Distribuidora ABC">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>RIF/NIT</label>
                                    <input type="text" id="proveedor-rif" name="rif" placeholder="Ej: J-12345678-0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Tel√©fono</label>
                                    <input type="tel" id="proveedor-telefono" name="telefono" placeholder="Ej: +58 412-1234567">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="proveedor-email" name="email" placeholder="contacto@proveedor.com">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Direcci√≥n *</label>
                                    <input type="text" id="proveedor-direccion" name="direccion" placeholder="Calle, n√∫mero, piso..." required>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>C√≥digo Postal</label>
                                    <input type="text" id="proveedor-codigo-postal" name="codigo_postal" placeholder="Ej: 28001">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Ciudad *</label>
                                    <input type="text" id="proveedor-ciudad" name="ciudad" placeholder="Ej: Madrid" required>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Provincia</label>
                                    <input type="text" id="proveedor-provincia" name="provincia" placeholder="Ej: Madrid">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Cuenta Contable</label>
                            <select id="proveedor-cuenta-contable" name="cuenta_contable_id">
                                <option value="">Seleccionar cuenta contable</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Notas Adicionales</label>
                            <textarea id="proveedor-notas" name="notas" placeholder="Informaci√≥n adicional sobre el proveedor"></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-success">
                            Adicionar
                        </button>
                    </form>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>RIF/NIT</th>
                            <th>Tel√©fono</th>
                            <th>Email</th>
                            <th>Direcci√≥n</th>
                            <th>Ciudad</th>
                            <th>C√≥digo Postal</th>
                            <th>Provincia</th>
                            <th>Cuenta Contable</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-proveedores">
                        <tr>
                            <td colspan="11" class="text-center text-muted">Cargando proveedores...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- PRODUCTOS MODULE -->
            <div id="productos" class="module-content">
                <h2 class="section-title">Cat√°logo de Productos</h2>

                <!-- Search Bar -->
                <div class="form-container" style="margin-bottom: 20px; padding: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Buscar Productos:</label>
                        <input type="text" id="buscar-productos" placeholder="Buscar por nombre, c√≥digo o barcode..." style="margin-top: 5px;">
                    </div>
                </div>

                <div class="form-container">
                    <h3 style="margin-bottom: 20px;">Registrar Nuevo Producto</h3>
                    
                    <form id="form-producto">
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Nombre del Producto *</label>
                                    <input type="text" id="producto-nombre" name="nombre" required placeholder="Ej: Arroz Blanco Premium">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>C√≥digo/SKU</label>
                                    <input type="text" id="producto-codigo" name="codigo" placeholder="Ej: ARR-001">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>C√≥digo de Barras</label>
                            <input type="text" id="producto-barcode" name="barcode" placeholder="Ej: 1234567890123">
                        </div>
                        
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Categor√≠a</label>
                                    <select id="producto-categoria" name="categoria">
                                        <option value="">Seleccionar categor√≠a</option>
                                        <option value="alimentos">Alimentos</option>
                                        <option value="bebidas">Bebidas</option>
                                        <option value="limpieza">Limpieza</option>
                                        <option value="aseo">Aseo Personal</option>
                                        <option value="otros">Otros</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Unidad de Medida *</label>
                                    <select id="producto-medida" name="medida_simbolo" required>
                                        <option value="">Seleccionar medida</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Precio de Referencia</label>
                                    <input type="number" step="0.01" id="producto-precio" name="precio_referencia" placeholder="0.00">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Stock M√≠nimo</label>
                                    <input type="number" step="0.01" id="producto-stock-min" name="stock_minimo" placeholder="0.00">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Descripci√≥n</label>
                            <textarea id="producto-descripcion" name="descripcion" placeholder="Descripci√≥n detallada del producto"></textarea>
                        </div>

                        <h4 style="margin-top: 30px; margin-bottom: 15px;">Informaci√≥n Contable</h4>

                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Tipo de Producto</label>
                                    <select id="producto-tipo-producto" name="tipo_producto_id">
                                        <option value="">Seleccionar tipo</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Cuenta Contable</label>
                                    <select id="producto-cuenta-contable" name="cuenta_contable_id">
                                        <option value="">Seleccionar cuenta</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Tipo de IVA</label>
                                    <select id="producto-tipo-iva" name="tipo_iva_id">
                                        <option value="">Seleccionar IVA</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Centro de Coste</label>
                                    <select id="producto-centro-coste" name="centro_coste_id">
                                        <option value="">Seleccionar centro</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success">
                            Adicionar
                        </button>
                    </form>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Barcode</th>
                            <th>Nombre</th>
                            <th>Categor√≠a</th>
                            <th>Unidad</th>
                            <th>Descripci√≥n</th>
                            <th>Stock M√≠n</th>
                            <th>Stock Actual</th>
                            <th>Estado</th>
                            <th>IVA</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-productos">
                        <tr>
                            <td colspan="11" class="text-center text-muted">Cargando productos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- MEDIDAS MODULE -->
            <div id="medidas" class="module-content">
                <h2 class="section-title">Unidades de Medida</h2>
                
                <div class="form-container">
                    <h3 style="margin-bottom: 20px;">Registrar Nueva Medida</h3>
                    
                    <form id="form-medida">
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Nombre de la Unidad *</label>
                                    <input type="text" id="medida-nombre" name="nombre" required placeholder="Ej: Kilogramos">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>S√≠mbolo/Abreviatura *</label>
                                    <input type="text" id="medida-simbolo" name="simbolo" required placeholder="Ej: kg">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Tipo de Medida</label>
                            <select id="medida-tipo" name="tipo">
                                <option value="">Seleccionar tipo</option>
                                <option value="peso">Peso</option>
                                <option value="volumen">Volumen</option>
                                <option value="longitud">Longitud</option>
                                <option value="cantidad">Cantidad</option>
                                <option value="area">√Årea</option>
                                <option value="otros">Otros</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Descripci√≥n</label>
                            <textarea id="medida-descripcion" name="descripcion" placeholder="Descripci√≥n o notas sobre esta unidad de medida"></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-success">
                            Adicionar
                        </button>
                    </form>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>S√≠mbolo</th>
                            <th>Tipo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-medidas">
                        <tr>
                            <td colspan="5" class="text-center text-muted">Cargando medidas...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- MAPEOS MODULE -->
            <div id="mapeos" class="module-content">
                <h2 class="section-title">Mapeo de Productos - Sistema Consolidado</h2>
                <p style="margin-bottom: 20px; color: #7f8c8d;">
                    Sistema completo para procesar archivos de proveedores, estandarizar productos y crear mapeos consolidados.
                </p>

                <!-- Supplier File Processing Section -->
                <div class="form-container">
                    <h3 style="margin-bottom: 20px;">üìÅ Procesar Archivo de Productos</h3>
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                        Sube archivos Excel/CSV con las siguientes columnas obligatorias:<br>
                        <strong>codigo, descripcion, cantidad, unidad_medida, precio, iva</strong>
                    </p>

                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px;">
                        <select id="proveedor-archivo" style="padding: 8px; border: 2px solid #e9ecef; border-radius: 6px; min-width: 200px;">
                            <option value="">Seleccionar Proveedor</option>
                        </select>
                        <input type="file" id="archivo-proveedor" accept=".xlsx,.xls,.csv" style="flex: 1; padding: 8px; border: 2px solid #e9ecef; border-radius: 6px;">
                        <button type="button" class="btn btn-primary" onclick="procesarArchivoProveedor()">Procesar Archivo</button>
                        <button type="button" class="btn btn-secondary" onclick="descargarPlantillaProveedor()">Descargar Plantilla</button>
                    </div>

                    <div id="archivo-preview" style="display: none; margin-top: 20px;">
                        <h4>üìã Productos Procesados - Asignar Mapeos</h4>
                        <div id="mapeos-preview-table" style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; margin-top: 10px;"></div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button type="button" class="btn btn-success" onclick="guardarMapeosConsolidados()">üíæ Guardar Mapeos</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelarMapeosArchivo()">‚ùå Cancelar</button>
                        </div>
                    </div>
                </div>

                <!-- Consolidated Products View -->
                <div class="form-container">
                    <h3 style="margin-bottom: 20px;">üìä Vista Consolidada de Productos</h3>
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                        Lista √∫nica consolidada con productos internos y sus precios por proveedor.
                    </p>

                    <div style="margin-bottom: 20px;">
                        <input type="text" id="buscar-consolidados" placeholder="Buscar productos..." style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px;">
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Producto Interno</th>
                                <th>C√≥digo Interno</th>
                                <th>Unidad</th>
                                <th>Proveedores y Precios</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-consolidados">
                            <tr>
                                <td colspan="5" class="text-center text-muted">Cargando productos consolidados...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="form-container">
                    <h3 style="margin-bottom: 20px;">‚ûï Crear Nuevo Mapeo Individual</h3>
                    
                    <form id="form-mapeo">
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Proveedor *</label>
                                    <select id="mapeo-proveedor" name="proveedor_id" required>
                                        <option value="">Seleccionar proveedor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Producto en tu Inventario *</label>
                                    <select id="mapeo-producto" name="producto_id" required>
                                        <option value="">Seleccionar producto</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Nombre que usa el Proveedor *</label>
                            <input type="text" id="mapeo-nombre-proveedor" name="nombre_proveedor" required placeholder="Ej: Arroz Diana 1kg">
                        </div>
                        
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>C√≥digo del Proveedor</label>
                                    <input type="text" id="mapeo-codigo-proveedor" name="codigo_proveedor" placeholder="C√≥digo que usa el proveedor">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Factor de Conversi√≥n</label>
                                    <input type="number" step="0.0001" id="mapeo-factor" name="factor_conversion" placeholder="1.0000" value="1">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Notas del Mapeo</label>
                            <textarea id="mapeo-notas" name="notas" placeholder="Informaci√≥n adicional sobre este mapeo"></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-success">
                            Adicionar
                        </button>
                    </form>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Proveedor</th>
                            <th>Nombre del Proveedor</th>
                            <th>Producto Inventario</th>
                            <th>Factor</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-mapeos">
                        <tr>
                            <td colspan="6" class="text-center text-muted">Cargando mapeos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- ALBARANES MODULE -->
            <div id="albaranes" class="module-content">
                <h2 class="section-title">Procesamiento de Albaranes</h2>
                <p style="margin-bottom: 20px; color: #7f8c8d;">
                    Gestiona la recepci√≥n y procesamiento autom√°tico de albaranes/entregas de proveedores.
                </p>

                <div class="form-container">
                    <h3 style="margin-bottom: 20px;">Registrar Nuevo Albar√°n</h3>

                    <form id="form-albaran">
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>N√∫mero de Albar√°n *</label>
                                    <input type="text" id="albaran-numero" name="numero_albaran" required placeholder="Ej: ALB-001-2024">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Proveedor *</label>
                                    <select id="albaran-proveedor" name="proveedor_id" required>
                                        <option value="">Seleccionar proveedor</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Fecha de Recepci√≥n *</label>
                                    <input type="date" id="albaran-fecha-recepcion" name="fecha_recepcion" required>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Fecha de Entrega</label>
                                    <input type="date" id="albaran-fecha-entrega" name="fecha_entrega">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Orden de Compra (opcional)</label>
                            <select id="albaran-orden" name="orden_compra_id">
                                <option value="">Seleccionar orden</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Notas</label>
                            <textarea id="albaran-notas" name="notas" placeholder="Notas adicionales del albar√°n"></textarea>
                        </div>

                        <div id="albaran-detalles">
                            <h4>Productos en el Albar√°n</h4>
                            <button type="button" class="btn btn-primary" onclick="agregarProductoAlbaran()">Agregar Producto</button>
                            <div id="productos-albaran"></div>
                        </div>

                        <button type="submit" class="btn btn-success">
                            Registrar Albar√°n
                        </button>
                    </form>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>N√∫mero Albar√°n</th>
                            <th>Proveedor</th>
                            <th>Fecha Recepci√≥n</th>
                            <th>Estado</th>
                            <th>Items</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-albaranes">
                        <tr>
                            <td colspan="6" class="text-center text-muted">Cargando albaranes...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- STOCK MODULE -->
            <div id="stock" class="module-content">
                <h2 class="section-title">Control de Stock</h2>
                
                <div class="form-container">
                    <h3 style="margin-bottom: 20px;">Registrar Movimiento de Stock</h3>
                    
                    <form id="form-stock">
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Producto *</label>
                                    <select id="stock-producto" name="producto_id" required>
                                        <option value="">Seleccionar producto</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Tipo de Movimiento *</label>
                                    <select id="stock-tipo" name="tipo_movimiento" required onchange="toggleAlmacenFields()">
                                        <option value="">Seleccionar tipo</option>
                                        <option value="entrada">Entrada</option>
                                        <option value="salida">Salida</option>
                                        <option value="transferencia">Transferencia</option>
                                        <option value="ajuste">Ajuste</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row" id="almacen-row" style="display: none;">
                            <div class="col-2">
                                <div class="form-group">
                                    <label id="almacen-label">Almac√©n Destino *</label>
                                    <select id="stock-almacen-destino" name="almacen_destino_id">
                                        <option value="">Seleccionar almac√©n</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-2" id="almacen-origen-col" style="display: none;">
                                <div class="form-group">
                                    <label>Almac√©n Origen *</label>
                                    <select id="stock-almacen-origen" name="almacen_origen_id">
                                        <option value="">Seleccionar almac√©n</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Cantidad *</label>
                                    <input type="number" step="0.001" id="stock-cantidad" name="cantidad" required placeholder="0.000">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Precio Unitario</label>
                                    <input type="number" step="0.01" id="stock-precio" name="precio_unitario" placeholder="0.00">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Proveedor (opcional)</label>
                                    <select id="stock-proveedor" name="proveedor_id">
                                        <option value="">Seleccionar proveedor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Referencia</label>
                                    <input type="text" id="stock-referencia" name="referencia" placeholder="Ej: Factura #12345">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Motivo/Descripci√≥n</label>
                            <input type="text" id="stock-motivo" name="motivo" placeholder="Ej: Compra, Venta, Ajuste por inventario">
                        </div>
                        
                        <div class="form-group">
                            <label>Notas</label>
                            <textarea id="stock-notas" name="notas" placeholder="Informaci√≥n adicional del movimiento"></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-success">
                            Adicionar
                        </button>
                    </form>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Producto</th>
                            <th>Tipo</th>
                            <th>Cantidad</th>
                            <th>Precio</th>
                            <th>Total</th>
                            <th>Almac√©n Origen</th>
                            <th>Almac√©n Destino</th>
                            <th>Proveedor</th>
                            <th>Motivo</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-stock">
                        <tr>
                            <td colspan="10" class="text-center text-muted">Cargando movimientos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- ALMACENES MODULE -->
            <div id="almacenes" class="module-content">
                <h2 class="section-title">Gesti√≥n de Almacenes</h2>

                <div class="form-container">
                    <h3 style="margin-bottom: 20px;">Registrar Nuevo Almac√©n</h3>

                    <form id="form-almacen">
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Nombre del Almac√©n *</label>
                                    <input type="text" id="almacen-nombre" name="nombre" required placeholder="Ej: Almac√©n Principal">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Ubicaci√≥n</label>
                                    <input type="text" id="almacen-ubicacion" name="ubicacion" placeholder="Ej: Planta Baja, Sector A">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Descripci√≥n</label>
                            <textarea id="almacen-descripcion" name="descripcion" placeholder="Descripci√≥n del almac√©n"></textarea>
                        </div>

                        <button type="submit" class="btn btn-success">
                            Adicionar
                        </button>
                    </form>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Ubicaci√≥n</th>
                            <th>Descripci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-almacenes">
                        <tr>
                            <td colspan="5" class="text-center text-muted">Cargando almacenes...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- CONFIGURACI√ìN MODULE -->
            <div id="configuracion" class="module-content">
                <h2 class="section-title">Configuraci√≥n del Hotel</h2>
                <p style="margin-bottom: 20px; color: #7f8c8d;">
                    Configure la informaci√≥n b√°sica de su hotel/empresa que aparecer√° en documentos y reportes.
                </p>

                <div class="form-container">
                    <h3 style="margin-bottom: 20px;">Informaci√≥n del Hotel/Empresa</h3>

                    <form id="form-configuracion-hotel">
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Nombre Legal *</label>
                                    <input type="text" id="hotel-nombre-legal" name="nombre_legal" placeholder="Ej: Hotel Paradiso S.L." required>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Nombre Social/Comercial</label>
                                    <input type="text" id="hotel-nombre-social" name="nombre_social" placeholder="Ej: Hotel Paradiso">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Direcci√≥n Completa *</label>
                            <textarea id="hotel-direccion" name="direccion" placeholder="Calle, n√∫mero, piso, puerta..." required></textarea>
                        </div>

                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Ciudad *</label>
                                    <input type="text" id="hotel-ciudad" name="ciudad" placeholder="Ej: Madrid" required>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>C√≥digo Postal</label>
                                    <input type="text" id="hotel-codigo-postal" name="codigo_postal" placeholder="Ej: 28001">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>NIF/CIF *</label>
                                    <input type="text" id="hotel-nif" name="nif" placeholder="Ej: B12345678" required>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Tel√©fono de Contacto</label>
                                    <input type="tel" id="hotel-telefono" name="telefono" placeholder="Ej: +34 91 123 45 67">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Email de Contacto</label>
                            <input type="email" id="hotel-email" name="email_contacto" placeholder="contacto@hotelparadiso.com">
                        </div>

                        <button type="submit" class="btn btn-success">
                            Guardar Configuraci√≥n
                        </button>
                    </form>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px;">üí° Informaci√≥n</h3>
                    <p style="margin-bottom: 10px;">
                        <strong>Nombre Legal:</strong> El nombre oficial registrado de la empresa (requerido para documentos legales).
                    </p>
                    <p style="margin-bottom: 10px;">
                        <strong>Nombre Social:</strong> El nombre comercial o marca que usa el hotel.
                    </p>
                    <p style="margin-bottom: 10px;">
                        <strong>NIF/CIF:</strong> N√∫mero de Identificaci√≥n Fiscal (obligatorio para facturaci√≥n).
                    </p>
                    <p>
                        Esta informaci√≥n se utilizar√° en facturas, albaranes y otros documentos oficiales.
                    </p>
                </div>
            </div>

            <!-- CONTABILIDAD MODULE -->
            <div id="contabilidad" class="module-content">
                <h2 class="section-title">Gesti√≥n Contable</h2>

                <div class="form-container" style="padding: 0;">
                    <div style="display: flex; border-bottom: 1px solid #e9ecef; margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="showAccountingTab('tipos-producto')" style="border-radius: 0; border-bottom: none;">Tipos de Producto</button>
                        <button class="btn btn-secondary" onclick="showAccountingTab('cuentas-contables')" style="border-radius: 0; border-bottom: none;">Cuentas Contables</button>
                        <button class="btn btn-secondary" onclick="showAccountingTab('tipos-iva')" style="border-radius: 0; border-bottom: none;">Tipos de IVA</button>
                        <button class="btn btn-secondary" onclick="showAccountingTab('centros-coste')" style="border-radius: 0; border-bottom: none;">Centros de Coste</button>
                    </div>

                    <!-- TIPOS DE PRODUCTO TAB -->
                    <div id="tab-tipos-producto" class="accounting-tab">
                        <h3 style="margin-bottom: 20px;">Tipos de Producto</h3>

                        <div class="form-container" style="margin-bottom: 20px;">
                            <form id="form-tipo-producto">
                                <div class="row">
                                    <div class="col-2">
                                        <div class="form-group">
                                            <label>Nombre del Tipo *</label>
                                            <input type="text" id="tipo-producto-nombre" name="nombre" required placeholder="Ej: Mercader√≠a">
                                        </div>
                                    </div>
                                    <div class="col-2">
                                        <div class="form-group">
                                            <label>Descripci√≥n</label>
                                            <input type="text" id="tipo-producto-descripcion" name="descripcion" placeholder="Descripci√≥n del tipo de producto">
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success">Adicionar</button>
                            </form>
                        </div>

                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Descripci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-tipos-producto">
                                <tr><td colspan="4" class="text-center text-muted">Cargando tipos de producto...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- CUENTAS CONTABLES TAB -->
                    <div id="tab-cuentas-contables" class="accounting-tab" style="display: none;">
                        <h3 style="margin-bottom: 20px;">Cuentas Contables</h3>

                        <div class="form-container" style="margin-bottom: 20px;">
                            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                <input type="file" id="excel-file" accept=".xlsx,.xls,.csv" style="flex: 1;">
                                <button type="button" class="btn btn-primary" onclick="importarCuentasExcel()">Importar Excel</button>
                            </div>

                            <form id="form-cuenta-contable">
                                <div class="row">
                                    <div class="col-2">
                                        <div class="form-group">
                                            <label>C√≥digo *</label>
                                            <input type="text" id="cuenta-codigo" name="codigo" required placeholder="Ej: 100000">
                                        </div>
                                    </div>
                                    <div class="col-2">
                                        <div class="form-group">
                                            <label>Nombre *</label>
                                            <input type="text" id="cuenta-nombre" name="nombre" required placeholder="Ej: CAJA">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Descripci√≥n</label>
                                    <input type="text" id="cuenta-descripcion" name="descripcion" placeholder="Descripci√≥n de la cuenta contable">
                                </div>
                                <button type="submit" class="btn btn-success">Adicionar</button>
                            </form>
                        </div>

                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>C√≥digo</th>
                                    <th>Nombre</th>
                                    <th>Descripci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-cuentas-contables">
                                <tr><td colspan="5" class="text-center text-muted">Cargando cuentas contables...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- TIPOS DE IVA TAB -->
                    <div id="tab-tipos-iva" class="accounting-tab" style="display: none;">
                        <h3 style="margin-bottom: 20px;">Tipos de IVA</h3>

                        <div class="form-container" style="margin-bottom: 20px;">
                            <form id="form-tipo-iva">
                                <div class="row">
                                    <div class="col-2">
                                        <div class="form-group">
                                            <label>Porcentaje *</label>
                                            <input type="number" step="0.01" id="iva-porcentaje" name="porcentaje" required placeholder="Ej: 21.00">
                                        </div>
                                    </div>
                                    <div class="col-2">
                                        <div class="form-group">
                                            <label>Nombre</label>
                                            <input type="text" id="iva-nombre" name="nombre" placeholder="Ej: General">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Descripci√≥n</label>
                                    <input type="text" id="iva-descripcion" name="descripcion" placeholder="Descripci√≥n del tipo de IVA">
                                </div>
                                <button type="submit" class="btn btn-success">Adicionar</button>
                            </form>
                        </div>

                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Porcentaje</th>
                                    <th>Nombre</th>
                                    <th>Descripci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-tipos-iva">
                                <tr><td colspan="5" class="text-center text-muted">Cargando tipos de IVA...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- CENTROS DE COSTE TAB -->
                    <div id="tab-centros-coste" class="accounting-tab" style="display: none;">
                        <h3 style="margin-bottom: 20px;">Centros de Coste</h3>

                        <div class="form-container" style="margin-bottom: 20px;">
                            <form id="form-centro-coste">
                                <div class="row">
                                    <div class="col-2">
                                        <div class="form-group">
                                            <label>Nombre del Centro *</label>
                                            <input type="text" id="centro-nombre" name="nombre" required placeholder="Ej: Administraci√≥n">
                                        </div>
                                    </div>
                                    <div class="col-2">
                                        <div class="form-group">
                                            <label>Descripci√≥n</label>
                                            <input type="text" id="centro-descripcion" name="descripcion" placeholder="Descripci√≥n del centro de coste">
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success">Adicionar</button>
                            </form>
                        </div>

                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Descripci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-centros-coste">
                                <tr><td colspan="4" class="text-center text-muted">Cargando centros de coste...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ORDENES COMPRA MODULE -->
            <div id="ordenes-compra" class="module-content">
                <h2 class="section-title">√ìrdenes de Compra</h2>

                <!-- Estado Inicial - Bot√≥n para nueva orden -->
                <div id="estado-inicial" class="form-container">
                    <div class="text-center" style="padding: 40px;">
                        <h3 style="margin-bottom: 20px;">Sistema de √ìrdenes de Compra</h3>
                        <p style="margin-bottom: 30px; color: #666;">Cree √≥rdenes de compra organizadas por proveedor mediante b√∫squeda y selecci√≥n de productos.</p>
                        <button type="button" class="btn btn-success btn-lg" onclick="abrirNuevoPedido()">
                            üõí Crear Nueva Orden de Compra
                        </button>
                    </div>
                </div>

                <!-- Pantalla de B√∫squeda de Productos -->
                <div id="pantalla-busqueda" class="form-container" style="display: none;">
                    <h3 style="margin-bottom: 20px;">Buscar y Seleccionar Productos</h3>

                    <div class="form-group">
                        <label>Buscar Producto:</label>
                        <input type="text" id="busqueda-producto" placeholder="Ingrese nombre del producto..." style="margin-top: 5px;">
                        <button type="button" class="btn btn-primary" onclick="buscarProducto()" style="margin-top: 10px;">Buscar</button>
                    </div>

                    <div id="resultados-busqueda" style="margin-top: 20px; display: none;">
                        <h4>Resultados de B√∫squeda</h4>
                        <div id="lista-resultados"></div>
                    </div>

                    <div style="margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="volverEstadoInicial()">‚Üê Volver</button>
                    </div>
                </div>

                <!-- Interface de Abas por Proveedor -->
                <div id="interface-abas" style="display: none;">
                    <h3 style="margin-bottom: 20px;">Productos Seleccionados por Proveedor</h3>

                    <div id="contenedor-abas" style="border-bottom: 1px solid #e9ecef; margin-bottom: 20px;">
                        <!-- Las abas se generar√°n din√°micamente aqu√≠ -->
                    </div>

                    <div id="contenido-abas">
                        <!-- El contenido de las abas se mostrar√° aqu√≠ -->
                    </div>

                    <div class="form-container" style="margin-top: 20px;">
                        <button type="button" class="btn btn-success btn-lg" onclick="generarOrdenesCompra()">
                            üìã Generar √ìrdenes de Compra
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="volverEstadoInicial()" style="margin-left: 10px;">
                            ‚Üê Volver al Inicio
                        </button>
                    </div>
                </div>

                <!-- Hist√≥rico de √ìrdenes de Compra -->
                <div class="form-container">
                    <h3 style="margin-bottom: 20px;">Hist√≥rico de √ìrdenes de Compra</h3>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>N√∫mero Orden</th>
                                <th>Proveedor</th>
                                <th>Fecha Creaci√≥n</th>
                                <th>Estado</th>
                                <th>Total</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-ordenes-compra">
                            <tr>
                                <td colspan="6" class="text-center text-muted">Cargando √≥rdenes...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- FACTURAS MODULE -->
            <div id="facturas" class="module-content">
                <h2 class="section-title">Gesti√≥n de Facturas</h2>

                <div class="form-container">
                    <h3 style="margin-bottom: 20px;">Registrar Nueva Factura</h3>

                    <form id="form-factura">
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>N√∫mero de Factura *</label>
                                    <input type="text" id="factura-numero" name="numero_factura" required placeholder="Ej: FAC-001-2024">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Proveedor *</label>
                                    <select id="factura-proveedor" name="proveedor_id" required>
                                        <option value="">Seleccionar proveedor</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Fecha de Emisi√≥n *</label>
                                    <input type="date" id="factura-fecha-emision" name="fecha_emision" required>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>Orden de Compra (opcional)</label>
                                    <select id="factura-orden" name="orden_compra_id">
                                        <option value="">Seleccionar orden</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="factura-detalles">
                            <h4>Productos en la Factura</h4>
                            <button type="button" class="btn btn-primary" onclick="agregarProductoFactura()">Agregar Producto</button>
                            <div id="productos-factura"></div>
                        </div>

                        <button type="submit" class="btn btn-success">
                            Registrar Factura
                        </button>
                    </form>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>N√∫mero Factura</th>
                            <th>Proveedor</th>
                            <th>Fecha Emisi√≥n</th>
                            <th>Estado</th>
                            <th>Total</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-facturas">
                        <tr>
                            <td colspan="6" class="text-center text-muted">Cargando facturas...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n base de la API
        const API_BASE = window.location.origin;  // Use the current origin
        let currentData = {
            proveedores: [],
            productos: [],
            medidas: [],
            mapeos: [],
            movimientos: [],
            tiposProducto: [],
            cuentasContables: [],
            tiposIVA: [],
            centrosCoste: []
        };

        // Objeto global para el pedido temporal
        let PEDIDO_TEMPORARIO = {
            ordens: {} // Estructura: {proveedor_id: [{producto_id, nome_produto, quantidade, preco_unitario, total}]}
        };

        // Funciones de utilidad
        function showAlert(message, type = 'success') {
            const alertElement = document.getElementById(`alert-${type}`);
            alertElement.textContent = message;
            alertElement.style.display = 'block';
            
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 5000);
        }

        async function showModule(moduleId) {
            // Ocultar todos los m√≥dulos
            document.querySelectorAll('.module-content').forEach(module => {
                module.classList.remove('active');
            });

            // Remover clase active de todos los nav-items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Mostrar el m√≥dulo seleccionado
            document.getElementById(moduleId).classList.add('active');

            // Activar el nav-item correspondiente
            event.target.closest('.nav-item').classList.add('active');

            // Cargar datos espec√≠ficos del m√≥dulo
            await loadModuleData(moduleId);
        }


        // Funciones API
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const config = {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                if (data) {
                    config.body = JSON.stringify(data);
                }

                const response = await fetch(`${API_BASE}/api${endpoint}`, config);
                const text = await response.text();
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    throw new Error(`Server returned HTML instead of JSON: ${text.substring(0, 200)}`);
                }

                if (!response.ok) {
                    throw new Error(result.error || 'Error en la petici√≥n');
                }

                return result;
            } catch (error) {
                console.error('Error en API:', error);
                showAlert(error.message, 'error');
                throw error;
            }
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const data = await apiCall('/dashboard');

                document.getElementById('total-proveedores').textContent = data.proveedores || 0;
                document.getElementById('total-productos').textContent = data.productos || 0;
                document.getElementById('total-medidas').textContent = data.medidas || 0;
                document.getElementById('total-mapeos').textContent = data.mapeos || 0;
                document.getElementById('total-almacenes').textContent = data.almacenes || 0;
                document.getElementById('ordenes-pendientes').textContent = data.ordenes_pendientes || 0;
                document.getElementById('productos-bajo-stock').textContent = data.productos_bajo_stock || 0;
                document.getElementById('facturas-pendientes').textContent = data.facturas_pendientes || 0;

                document.getElementById('system-status').innerHTML = `
                    <p>‚úÖ Sistema conectado y funcionando</p>
                    <p>üìä √öltima actualizaci√≥n: ${new Date().toLocaleString()}</p>
                `;
            } catch (error) {
                document.getElementById('system-status').innerHTML = `
                    <p>‚ùå Error conectando al servidor</p>
                    <p>üîß Verifica que el servidor est√© ejecut√°ndose</p>
                `;
            }
        }

        // Proveedores
        async function loadProveedores() {
            try {
                const proveedores = await apiCall('/proveedores');
                currentData.proveedores = proveedores;
                renderProveedores();
            } catch (error) {
                document.getElementById('tabla-proveedores').innerHTML = `
                    <tr><td colspan="6" class="text-center text-muted">Error cargando proveedores</td></tr>
                `;
            }
        }

        function renderProveedores() {
            const tbody = document.getElementById('tabla-proveedores');

            if (currentData.proveedores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">No hay proveedores registrados</td></tr>';
                return;
            }

            tbody.innerHTML = currentData.proveedores.map(proveedor => `
                <tr>
                    <td>${proveedor.id}</td>
                    <td>${proveedor.nombre}</td>
                    <td>${proveedor.rif || '-'}</td>
                    <td>${proveedor.telefono || '-'}</td>
                    <td>${proveedor.email || '-'}</td>
                    <td>${proveedor.direccion || '-'}</td>
                    <td>${proveedor.ciudad || '-'}</td>
                    <td>${proveedor.codigo_postal || '-'}</td>
                    <td>${proveedor.provincia || '-'}</td>
                    <td>${proveedor.cuenta_contable_codigo ? `${proveedor.cuenta_contable_codigo} - ${proveedor.cuenta_contable_nombre}` : '-'}</td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="editarProveedor(${proveedor.id})" style="margin-right: 5px;">‚úèÔ∏è Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarProveedor(${proveedor.id})">üóëÔ∏è Borrar</button>
                    </td>
                </tr>
            `).join('');
        }

        document.getElementById('form-proveedor').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                await apiCall('/proveedores', 'POST', data);
                showAlert('Proveedor registrado exitosamente');
                e.target.reset();
                loadProveedores();
            } catch (error) {
                // Error ya mostrado en apiCall
            }
        });

        async function eliminarProveedor(id) {
            if (confirm('¬øEst√°s seguro de eliminar este proveedor?')) {
                try {
                    await apiCall(`/proveedores/${id}`, 'DELETE');
                    showAlert('Proveedor eliminado exitosamente');
                    loadProveedores();
                } catch (error) {
                    // Error ya mostrado en apiCall
                }
            }
        }

        async function editarProveedor(id) {
            const proveedor = currentData.proveedores.find(p => p.id === id);
            if (!proveedor) return;

            // Crear un modal simple para editar
            const modalHtml = `
                <div id="edit-proveedor-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
                        <h3>Editar Proveedor</h3>
                        <form id="form-editar-proveedor">
                            <div class="row">
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>Nombre del Proveedor *</label>
                                        <input type="text" id="edit-nombre" name="nombre" value="${proveedor.nombre}" required placeholder="Ej: Distribuidora ABC">
                                    </div>
                                </div>
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>RIF/NIT</label>
                                        <input type="text" id="edit-rif" name="rif" value="${proveedor.rif || ''}" placeholder="Ej: J-12345678-0">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>Tel√©fono</label>
                                        <input type="tel" id="edit-telefono" name="telefono" value="${proveedor.telefono || ''}" placeholder="Ej: +58 412-1234567">
                                    </div>
                                </div>
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>Email</label>
                                        <input type="email" id="edit-email" name="email" value="${proveedor.email || ''}" placeholder="contacto@proveedor.com">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>Direcci√≥n *</label>
                                        <input type="text" id="edit-direccion" name="direccion" value="${proveedor.direccion || ''}" placeholder="Calle, n√∫mero, piso..." required>
                                    </div>
                                </div>
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>C√≥digo Postal</label>
                                        <input type="text" id="edit-codigo-postal" name="codigo_postal" value="${proveedor.codigo_postal || ''}" placeholder="Ej: 28001">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>Ciudad *</label>
                                        <input type="text" id="edit-ciudad" name="ciudad" value="${proveedor.ciudad || ''}" placeholder="Ej: Madrid" required>
                                    </div>
                                </div>
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>Provincia</label>
                                        <input type="text" id="edit-provincia" name="provincia" value="${proveedor.provincia || ''}" placeholder="Ej: Madrid">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Cuenta Contable</label>
                                <select id="edit-cuenta-contable" name="cuenta_contable_id">
                                    <option value="">Seleccionar cuenta contable</option>
                                    ${currentData.cuentasContables.map(cuenta => `<option value="${cuenta.id}" ${proveedor.cuenta_contable_id == cuenta.id ? 'selected' : ''}>${cuenta.codigo} - ${cuenta.nombre}</option>`).join('')}
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Notas Adicionales</label>
                                <textarea id="edit-notas" name="notas">${proveedor.notas || ''}</textarea>
                            </div>

                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" class="btn" onclick="cerrarModalProveedor()">Cancelar</button>
                                <button type="submit" class="btn btn-success">Guardar Cambios</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('form-editar-proveedor').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);

                try {
                    await apiCall(`/proveedores/${id}`, 'PUT', data);
                    showAlert('Proveedor actualizado exitosamente');
                    cerrarModalProveedor();
                    loadProveedores();
                } catch (error) {
                    // Error ya mostrado
                }
            });
        }

        function cerrarModalProveedor() {
            const modal = document.getElementById('edit-proveedor-modal');
            if (modal) modal.remove();
        }

        // Productos
        async function loadProductos() {
            try {
                const productos = await apiCall('/productos');
                currentData.productos = productos;
                renderProductos();
            } catch (error) {
                document.getElementById('tabla-productos').innerHTML = `
                    <tr><td colspan="7" class="text-center text-muted">Error cargando productos</td></tr>
                `;
            }
        }

        function renderProductos(productos = currentData.productos) {
            const tbody = document.getElementById('tabla-productos');

            if (productos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">No hay productos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = productos.map(producto => `
                <tr>
                    <td>${producto.codigo}</td>
                    <td>${producto.barcode || '-'}</td>
                    <td>${producto.nombre}</td>
                    <td>${producto.categoria || '-'}</td>
                    <td>${producto.medida_simbolo}</td>
                    <td>${producto.descripcion || ''}</td>
                    <td>${producto.stock_minimo || 0}</td>
                    <td>${producto.stock_actual || 0}</td>
                    <td><span class="badge badge-${producto.estado_stock.toLowerCase()}">${producto.estado_stock}</span></td>
                    <td>${producto.tipo_iva_porcentaje ? `${producto.tipo_iva_porcentaje}%` : '-'}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editarProducto(${producto.id})">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarProducto(${producto.id})">Borrar</button>
                    </td>
                </tr>
            `).join('');
        }

        function filtrarProductos() {
            const searchTerm = document.getElementById('buscar-productos').value.toLowerCase();
            const productosFiltrados = currentData.productos.filter(producto =>
                producto.nombre.toLowerCase().includes(searchTerm) ||
                producto.codigo.toLowerCase().includes(searchTerm) ||
                (producto.barcode && producto.barcode.toLowerCase().includes(searchTerm)) ||
                (producto.categoria && producto.categoria.toLowerCase().includes(searchTerm))
            );
            renderProductos(productosFiltrados);
        }

        document.getElementById('form-producto').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                await apiCall('/productos', 'POST', data);
                showAlert('Producto registrado exitosamente');
                e.target.reset();
                loadProductos();
            } catch (error) {
                // Error ya mostrado en apiCall
            }
        });

        async function eliminarProducto(id) {
            if (confirm('¬øEst√°s seguro de eliminar este producto?')) {
                try {
                    await apiCall(`/productos/${id}`, 'DELETE');
                    showAlert('Producto eliminado exitosamente');
                    loadProductos();
                } catch (error) {
                    // Error ya mostrado en apiCall
                }
            }
        }

        async function editarProducto(id) {
            const producto = currentData.productos.find(p => p.id === id);
            if (!producto) return;

            // Crear un modal simple para editar
            const modalHtml = `
                <div id="edit-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
                        <h3>Editar Producto</h3>
                        <form id="form-editar-producto">
                            <div class="row">
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>Nombre *</label>
                                        <input type="text" id="edit-nombre" name="nombre" value="${producto.nombre}" required>
                                    </div>
                                </div>
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>C√≥digo</label>
                                        <input type="text" id="edit-codigo" name="codigo" value="${producto.codigo || ''}">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>C√≥digo de Barras</label>
                                <input type="text" id="edit-barcode" name="barcode" value="${producto.barcode || ''}">
                            </div>
                            <div class="row">
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>Categor√≠a</label>
                                        <select id="edit-categoria" name="categoria">
                                            <option value="">Seleccionar categor√≠a</option>
                                            <option value="alimentos" ${producto.categoria === 'alimentos' ? 'selected' : ''}>Alimentos</option>
                                            <option value="bebidas" ${producto.categoria === 'bebidas' ? 'selected' : ''}>Bebidas</option>
                                            <option value="limpieza" ${producto.categoria === 'limpieza' ? 'selected' : ''}>Limpieza</option>
                                            <option value="aseo" ${producto.categoria === 'aseo' ? 'selected' : ''}>Aseo Personal</option>
                                            <option value="otros" ${producto.categoria === 'otros' ? 'selected' : ''}>Otros</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>Unidad de Medida *</label>
                                        <select id="edit-medida" name="medida_simbolo" required>
                                            <option value="">Seleccionar medida</option>
                                            ${currentData.medidas.map(medida => `<option value="${medida.simbolo}" ${producto.medida_simbolo === medida.simbolo ? 'selected' : ''}>${medida.nombre} (${medida.simbolo})</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>Precio de Referencia</label>
                                        <input type="number" step="0.01" id="edit-precio" name="precio_referencia" value="${producto.precio_referencia || 0}">
                                    </div>
                                </div>
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>Stock M√≠nimo</label>
                                        <input type="number" step="0.01" id="edit-stock-min" name="stock_minimo" value="${producto.stock_minimo || 0}">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Descripci√≥n</label>
                                <textarea id="edit-descripcion" name="descripcion">${producto.descripcion || ''}</textarea>
                            </div>

                            <h4 style="margin-top: 20px; margin-bottom: 10px;">Informaci√≥n Contable</h4>

                            <div class="row">
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>Tipo de Producto</label>
                                        <select id="edit-tipo-producto" name="tipo_producto_id">
                                            <option value="">Seleccionar tipo</option>
                                            ${currentData.tiposProducto.map(tipo => `<option value="${tipo.id}" ${producto.tipo_producto_id == tipo.id ? 'selected' : ''}>${tipo.nombre}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>Cuenta Contable</label>
                                        <select id="edit-cuenta-contable" name="cuenta_contable_id">
                                            <option value="">Seleccionar cuenta</option>
                                            ${currentData.cuentasContables.map(cuenta => `<option value="${cuenta.id}" ${producto.cuenta_contable_id == cuenta.id ? 'selected' : ''}>${cuenta.codigo} - ${cuenta.nombre}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>Tipo de IVA</label>
                                        <select id="edit-tipo-iva" name="tipo_iva_id">
                                            <option value="">Seleccionar IVA</option>
                                            ${currentData.tiposIVA.map(iva => `<option value="${iva.id}" ${producto.tipo_iva_id == iva.id ? 'selected' : ''}>${iva.nombre} (${iva.porcentaje}%)</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-2">
                                    <div class="form-group">
                                        <label>Centro de Coste</label>
                                        <select id="edit-centro-coste" name="centro_coste_id">
                                            <option value="">Seleccionar centro</option>
                                            ${currentData.centrosCoste.map(centro => `<option value="${centro.id}" ${producto.centro_coste_id == centro.id ? 'selected' : ''}>${centro.nombre}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" class="btn" onclick="cerrarModal()">Cancelar</button>
                                <button type="submit" class="btn btn-success">Guardar Cambios</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('form-editar-producto').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);

                try {
                    await apiCall(`/productos/${id}`, 'PUT', data);
                    showAlert('Producto actualizado exitosamente');
                    cerrarModal();
                    loadProductos();
                } catch (error) {
                    // Error ya mostrado
                }
            });
        }

        function cerrarModal() {
            const modal = document.getElementById('edit-modal');
            if (modal) modal.remove();
        }

        // Medidas
        async function loadMedidas() {
            try {
                const medidas = await apiCall('/medidas');
                currentData.medidas = medidas;
                renderMedidas();
                updateMedidasSelect();
            } catch (error) {
                document.getElementById('tabla-medidas').innerHTML = `
                    <tr><td colspan="5" class="text-center text-muted">Error cargando medidas</td></tr>
                `;
            }
        }

        function renderMedidas() {
            const tbody = document.getElementById('tabla-medidas');
            
            if (currentData.medidas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay medidas registradas</td></tr>';
                return;
            }
            
            tbody.innerHTML = currentData.medidas.map(medida => `
                <tr>
                    <td>${medida.id}</td>
                    <td>${medida.nombre}</td>
                    <td>${medida.simbolo}</td>
                    <td>${medida.tipo || '-'}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="eliminarMedida(${medida.id})">Borrar</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateMedidasSelect() {
            const select = document.getElementById('producto-medida');
            select.innerHTML = '<option value="">Seleccionar medida</option>';
            
            currentData.medidas.forEach(medida => {
                const option = document.createElement('option');
                option.value = medida.simbolo;
                option.textContent = `${medida.nombre} (${medida.simbolo})`;
                select.appendChild(option);
            });
        }

        document.getElementById('form-medida').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                await apiCall('/medidas', 'POST', data);
                showAlert('Medida registrada exitosamente');
                e.target.reset();
                loadMedidas();
            } catch (error) {
                // Error ya mostrado en apiCall
            }
        });

        async function eliminarMedida(id) {
            if (confirm('¬øEst√°s seguro de eliminar esta medida?')) {
                try {
                    await apiCall(`/medidas/${id}`, 'DELETE');
                    showAlert('Medida eliminada exitosamente');
                    loadMedidas();
                } catch (error) {
                    // Error ya mostrado en apiCall
                }
            }
        }

        // Mapeos
        async function loadMapeos() {
            try {
                const mapeos = await apiCall('/mapeos');
                currentData.mapeos = mapeos;
                renderMapeos();
            } catch (error) {
                document.getElementById('tabla-mapeos').innerHTML = `
                    <tr><td colspan="6" class="text-center text-muted">Error cargando mapeos</td></tr>
                `;
            }
        }

        // Variables para Excel de mapeos
        let excelMapeosData = [];
        let sessionId = null;

        // Procesar Excel de mapeos
        async function procesarExcelMapeos() {
            const fileInput = document.getElementById('excel-mapeos-file');
            const file = fileInput.files[0];

            if (!file) {
                showAlert('Por favor selecciona un archivo Excel', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('excel', file);

            try {
                showAlert('Procesando archivo Excel...');
                const result = await fetch(`${API_BASE}/api/mapeos/procesar-excel`, {
                    method: 'POST',
                    body: formData
                });

                const data = await result.json();

                if (!result.ok) {
                    throw new Error(data.error || 'Error procesando archivo');
                }

                excelMapeosData = data.productos;
                sessionId = data.session_id;

                showAlert(`Archivo procesado. ${data.productos.length} productos encontrados.`);
                mostrarVistaMapeosExcel();

            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        // Mostrar vista de mapeos Excel
        function mostrarVistaMapeosExcel() {
            const container = document.getElementById('mapeos-preview-table');

            if (excelMapeosData.length === 0) {
                container.innerHTML = '<p>No hay productos para mapear.</p>';
                return;
            }

            let html = `
                <table class="data-table" style="margin: 0;">
                    <thead>
                        <tr>
                            <th>Producto Proveedor</th>
                            <th>C√≥digo Proveedor</th>
                            <th>Producto Inventario</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            excelMapeosData.forEach((producto, index) => {
                html += `
                    <tr>
                        <td>${producto.nombre_proveedor}</td>
                        <td>${producto.codigo_proveedor || '-'}</td>
                        <td>
                            <select id="map-${index}" onchange="actualizarMapeoExcel(${index})" style="width: 100%; padding: 4px;">
                                <option value="">Seleccionar producto...</option>
                                <option value="new">‚ûï Crear nuevo producto</option>
                                ${currentData.productos.map(p => `<option value="${p.id}">${p.nombre} (${p.codigo})</option>`).join('')}
                            </select>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="verDetallesProducto(${index})">Ver</button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
            document.getElementById('excel-preview').style.display = 'block';
        }

        // Actualizar mapeo Excel
        function actualizarMapeoExcel(index) {
            const select = document.getElementById(`map-${index}`);
            const productoId = select.value;

            if (productoId === 'new') {
                crearProductoDesdeExcel(index);
            } else {
                excelMapeosData[index].producto_id = productoId ? parseInt(productoId) : null;
            }
        }

        // Crear producto desde Excel
        async function crearProductoDesdeExcel(index) {
            const producto = excelMapeosData[index];

            // Crear modal para nuevo producto
            const modalHtml = `
                <div id="create-product-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80%; overflow-y: auto;">
                        <h3>Crear Nuevo Producto</h3>
                        <form id="form-create-product-excel">
                            <div class="form-group">
                                <label>Nombre del Producto *</label>
                                <input type="text" id="new-nombre" name="nombre" value="${producto.nombre_proveedor}" required>
                            </div>
                            <div class="form-group">
                                <label>C√≥digo/SKU</label>
                                <input type="text" id="new-codigo" name="codigo" value="${producto.codigo_proveedor || ''}">
                            </div>
                            <div class="form-group">
                                <label>Unidad de Medida *</label>
                                <select id="new-medida" name="medida_simbolo" required>
                                    <option value="">Seleccionar medida</option>
                                    ${currentData.medidas.map(m => `<option value="${m.simbolo}">${m.nombre} (${m.simbolo})</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Precio de Referencia</label>
                                <input type="number" step="0.01" id="new-precio" name="precio_referencia" placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label>Stock M√≠nimo</label>
                                <input type="number" step="0.01" id="new-stock-min" name="stock_minimo" placeholder="0.00">
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                <button type="button" class="btn" onclick="cerrarModalCrearProducto()">Cancelar</button>
                                <button type="submit" class="btn btn-success">Crear Producto</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('form-create-product-excel').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);

                try {
                    const result = await apiCall('/productos', 'POST', data);
                    showAlert('Producto creado exitosamente');

                    // Recargar productos y actualizar el select
                    await loadProductos();
                    loadSelectOptions();

                    // Actualizar el mapeo
                    excelMapeosData[index].producto_id = result.id;
                    document.getElementById(`map-${index}`).value = result.id;

                    cerrarModalCrearProducto();
                } catch (error) {
                    // Error ya mostrado
                }
            });
        }

        // Cerrar modal crear producto
        function cerrarModalCrearProducto() {
            const modal = document.getElementById('create-product-modal');
            if (modal) modal.remove();
        }

        // Ver detalles del producto Excel
        function verDetallesProducto(index) {
            const producto = excelMapeosData[index];
            alert(`Producto: ${producto.nombre_proveedor}\nC√≥digo: ${producto.codigo_proveedor || 'N/A'}\nPrecio: ${producto.precio_unitario || 'N/A'}`);
        }

        // Guardar mapeos Excel
        async function guardarMapeosExcel() {
            if (!sessionId) {
                showAlert('Sesi√≥n expirada. Vuelve a procesar el archivo.', 'error');
                return;
            }

            // Filtrar solo los productos que tienen mapeo
            const mapeosValidos = excelMapeosData.filter(p => p.producto_id);

            if (mapeosValidos.length === 0) {
                showAlert('No hay productos mapeados para guardar.', 'error');
                return;
            }

            try {
                const result = await apiCall('/mapeos/guardar-excel', 'POST', {
                    session_id: sessionId,
                    mapeos: mapeosValidos
                });

                showAlert(`Mapeos guardados exitosamente. ${result.creados} mapeos creados.`);

                // Limpiar y recargar
                cancelarMapeosExcel();
                loadMapeos();

            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        // Cancelar mapeos Excel
        function cancelarMapeosExcel() {
            excelMapeosData = [];
            sessionId = null;
            document.getElementById('excel-preview').style.display = 'none';
            document.getElementById('excel-mapeos-file').value = '';
        }

        // Procesar archivo de proveedor
        async function procesarArchivoProveedor() {
            const fileInput = document.getElementById('archivo-proveedor');
            const proveedorSelect = document.getElementById('proveedor-archivo');
            const file = fileInput.files[0];
            const proveedorId = proveedorSelect.value;

            if (!file) {
                showAlert('Por favor selecciona un archivo', 'error');
                return;
            }

            if (!proveedorId) {
                showAlert('Por favor selecciona un proveedor', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('archivo', file);
            formData.append('proveedor_id', proveedorId);

            try {
                showAlert('Procesando archivo...');
                const result = await fetch(`${API_BASE}/api/mapeos/procesar-archivo-proveedor`, {
                    method: 'POST',
                    body: formData
                });

                const data = await result.json();

                if (!result.ok) {
                    throw new Error(data.error || 'Error procesando archivo');
                }

                showAlert(`Archivo procesado exitosamente. ${data.productos.length} productos encontrados.`);
                mostrarVistaMapeosArchivo(data.productos, data.session_id);

            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        // Mostrar vista de mapeos de archivo
        function mostrarVistaMapeosArchivo(productos, sessionId) {
            const container = document.getElementById('mapeos-preview-table');

            if (productos.length === 0) {
                container.innerHTML = '<p>No hay productos para mapear.</p>';
                return;
            }

            let html = `
                <table class="data-table" style="margin: 0;">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Descripci√≥n</th>
                            <th>Cantidad</th>
                            <th>Unidad</th>
                            <th>Precio</th>
                            <th>IVA</th>
                            <th>Producto Inventario</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            productos.forEach((producto, index) => {
                html += `
                    <tr>
                        <td>${producto.codigo_proveedor || '-'}</td>
                        <td>${producto.nombre_proveedor_original}</td>
                        <td>${producto.cantidad_proveedor}</td>
                        <td>${producto.unidad_proveedor}</td>
                        <td>${producto.precio_proveedor}</td>
                        <td>${producto.iva_proveedor}%</td>
                        <td>
                            <select id="map-archivo-${index}" onchange="actualizarMapeoArchivo(${index})" style="width: 100%; padding: 4px;">
                                <option value="">Seleccionar producto...</option>
                                <option value="new">‚ûï Crear nuevo producto</option>
                                ${currentData.productos.map(p => `<option value="${p.id}">${p.nombre} (${p.codigo})</option>`).join('')}
                            </select>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="verDetallesProductoArchivo(${index})">Ver</button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
            document.getElementById('archivo-preview').style.display = 'block';

            // Guardar datos globalmente para usar en otras funciones
            window.archivoMapeosData = productos;
            window.archivoSessionId = sessionId;
        }

        // Actualizar mapeo de archivo
        function actualizarMapeoArchivo(index) {
            const select = document.getElementById(`map-archivo-${index}`);
            const productoId = select.value;

            if (productoId === 'new') {
                crearProductoDesdeArchivo(index);
            } else {
                window.archivoMapeosData[index].producto_interno_id = productoId ? parseInt(productoId) : null;
            }
        }

        // Crear producto desde archivo
        async function crearProductoDesdeArchivo(index) {
            const producto = window.archivoMapeosData[index];

            const modalHtml = `
                <div id="create-product-archivo-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80%; overflow-y: auto;">
                        <h3>Crear Nuevo Producto</h3>
                        <form id="form-create-product-archivo">
                            <div class="form-group">
                                <label>Nombre del Producto *</label>
                                <input type="text" id="new-nombre-archivo" name="nombre" value="${producto.nombre_proveedor_original}" required>
                            </div>
                            <div class="form-group">
                                <label>C√≥digo/SKU</label>
                                <input type="text" id="new-codigo-archivo" name="codigo" value="${producto.codigo_proveedor || ''}">
                            </div>
                            <div class="form-group">
                                <label>Unidad de Medida *</label>
                                <select id="new-medida-archivo" name="medida_simbolo" required>
                                    <option value="">Seleccionar medida</option>
                                    ${currentData.medidas.map(m => `<option value="${m.simbolo}" ${producto.unidad_proveedor === m.simbolo ? 'selected' : ''}>${m.nombre} (${m.simbolo})</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Precio de Referencia</label>
                                <input type="number" step="0.01" id="new-precio-archivo" name="precio_referencia" value="${producto.precio_proveedor || 0}">
                            </div>
                            <div class="form-group">
                                <label>Stock M√≠nimo</label>
                                <input type="number" step="0.01" id="new-stock-min-archivo" name="stock_minimo" placeholder="0.00">
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                <button type="button" class="btn" onclick="cerrarModalCrearProductoArchivo()">Cancelar</button>
                                <button type="submit" class="btn btn-success">Crear Producto</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('form-create-product-archivo').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);

                try {
                    const result = await apiCall('/productos', 'POST', data);
                    showAlert('Producto creado exitosamente');

                    await loadProductos();
                    loadSelectOptions();

                    window.archivoMapeosData[index].producto_interno_id = result.id;
                    document.getElementById(`map-archivo-${index}`).value = result.id;

                    cerrarModalCrearProductoArchivo();
                } catch (error) {
                    // Error ya mostrado
                }
            });
        }

        // Cerrar modal crear producto archivo
        function cerrarModalCrearProductoArchivo() {
            const modal = document.getElementById('create-product-archivo-modal');
            if (modal) modal.remove();
        }

        // Ver detalles del producto archivo
        function verDetallesProductoArchivo(index) {
            const producto = window.archivoMapeosData[index];
            alert(`C√≥digo: ${producto.codigo_proveedor || 'N/A'}\nDescripci√≥n: ${producto.nombre_proveedor_original}\nCantidad: ${producto.cantidad_proveedor}\nUnidad: ${producto.unidad_proveedor}\nPrecio: ${producto.precio_proveedor}\nIVA: ${producto.iva_proveedor}%`);
        }

        // Guardar mapeos de archivo
        async function guardarMapeosConsolidados() {
            if (!window.archivoSessionId) {
                showAlert('Sesi√≥n expirada. Vuelve a procesar el archivo.', 'error');
                return;
            }

            const mapeosValidos = window.archivoMapeosData.filter(p => p.producto_interno_id);

            if (mapeosValidos.length === 0) {
                showAlert('No hay productos mapeados para guardar.', 'error');
                return;
            }

            try {
                const result = await apiCall('/mapeos/guardar-archivo', 'POST', {
                    session_id: window.archivoSessionId,
                    mapeos: mapeosValidos
                });

                showAlert(`Mapeos guardados exitosamente. ${result.creados} mapeos creados.`);

                cancelarMapeosArchivo();
                loadMapeos();

            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        // Cancelar mapeos archivo
        function cancelarMapeosArchivo() {
            window.archivoMapeosData = [];
            window.archivoSessionId = null;
            document.getElementById('archivo-preview').style.display = 'none';
            document.getElementById('archivo-proveedor').value = '';
            document.getElementById('proveedor-archivo').value = '';
        }

        // Descargar plantilla de proveedor
        function descargarPlantillaProveedor() {
            const csvContent = "data:text/csv;charset=utf-8," +
                "codigo,descripcion,cantidad,unidad_medida,precio,iva\n" +
                "PROD001,Ejemplo Producto 1,100,kg,10.50,21\n" +
                "PROD002,Ejemplo Producto 2,50,l,25.00,10\n";

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "plantilla_proveedor.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAlert('Plantilla descargada. Abre el archivo en Excel y agrega tus productos.');
        }

        // Descargar plantilla de mapeos
        function descargarPlantillaMapeos() {
            const csvContent = "data:text/csv;charset=utf-8," +
                "nombre_proveedor,codigo_proveedor,precio_unitario\n" +
                "Ejemplo Producto 1,PROD001,10.50\n" +
                "Ejemplo Producto 2,PROD002,25.00\n";

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "plantilla_mapeos.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAlert('Plantilla descargada. Abre el archivo en Excel y agrega tus productos.');
        }

        function renderMapeos() {
            const tbody = document.getElementById('tabla-mapeos');
            
            if (currentData.mapeos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay mapeos registrados</td></tr>';
                return;
            }
            
            tbody.innerHTML = currentData.mapeos.map(mapeo => `
                <tr>
                    <td>${mapeo.id}</td>
                    <td>${mapeo.proveedor_nombre}</td>
                    <td>${mapeo.nombre_proveedor}</td>
                    <td>${mapeo.producto_nombre}</td>
                    <td>${mapeo.factor_conversion}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="eliminarMapeo(${mapeo.id})">Borrar</button>
                    </td>
                </tr>
            `).join('');
        }

        document.getElementById('form-mapeo').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                await apiCall('/mapeos', 'POST', data);
                showAlert('Mapeo creado exitosamente');
                e.target.reset();
                loadMapeos();
            } catch (error) {
                // Error ya mostrado en apiCall
            }
        });

        async function eliminarMapeo(id) {
            if (confirm('¬øEst√°s seguro de eliminar este mapeo?')) {
                try {
                    await apiCall(`/mapeos/${id}`, 'DELETE');
                    showAlert('Mapeo eliminado exitosamente');
                    loadMapeos();
                } catch (error) {
                    // Error ya mostrado en apiCall
                }
            }
        }

        // Stock
        async function loadMovimientosStock() {
            try {
                const movimientos = await apiCall('/stock/movimientos');
                currentData.movimientos = movimientos;
                renderMovimientosStock();
            } catch (error) {
                document.getElementById('tabla-stock').innerHTML = `
                    <tr><td colspan="8" class="text-center text-muted">Error cargando movimientos</td></tr>
                `;
            }
        }

        function renderMovimientosStock() {
            const tbody = document.getElementById('tabla-stock');

            if (currentData.movimientos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No hay movimientos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = currentData.movimientos.map(mov => `
                <tr>
                    <td>${new Date(mov.fecha_movimiento).toLocaleDateString()}</td>
                    <td>${mov.producto_nombre}</td>
                    <td><span class="badge ${getMovimientoBadge(mov.tipo_movimiento)}">${mov.tipo_movimiento.toUpperCase()}</span></td>
                    <td>${mov.cantidad}</td>
                    <td>${mov.precio_unitario || 0}</td>
                    <td>${mov.total || 0}</td>
                    <td>${mov.almacen_origen_nombre || '-'}</td>
                    <td>${mov.almacen_destino_nombre || '-'}</td>
                    <td>${mov.proveedor_nombre || '-'}</td>
                    <td>${mov.motivo || '-'}</td>
                </tr>
            `).join('');
        }

        function getMovimientoBadge(tipo) {
            const badges = {
                'entrada': 'badge-ok',
                'salida': 'badge-bajo',
                'transferencia': 'badge-medio',
                'ajuste': 'badge-medio'
            };
            return badges[tipo] || 'badge-medio';
        }

        document.getElementById('form-stock').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                await apiCall('/stock/movimiento', 'POST', data);
                showAlert('Movimiento de stock registrado exitosamente');
                e.target.reset();
                loadMovimientosStock();
                loadDashboard(); // Actualizar dashboard
            } catch (error) {
                // Error ya mostrado en apiCall
            }
        });

        // Funci√≥n para mostrar/ocultar campos de almac√©n seg√∫n tipo de movimiento
        function toggleAlmacenFields() {
            const tipo = document.getElementById('stock-tipo').value;
            const almacenRow = document.getElementById('almacen-row');
            const almacenLabel = document.getElementById('almacen-label');
            const origenCol = document.getElementById('almacen-origen-col');

            if (tipo === 'transferencia') {
                almacenRow.style.display = 'flex';
                almacenLabel.textContent = 'Almac√©n Destino *';
                origenCol.style.display = 'block';
            } else if (tipo === 'entrada' || tipo === 'ajuste') {
                almacenRow.style.display = 'flex';
                almacenLabel.textContent = 'Almac√©n Destino *';
                origenCol.style.display = 'none';
            } else if (tipo === 'salida') {
                almacenRow.style.display = 'flex';
                almacenLabel.textContent = 'Almac√©n Origen *';
                origenCol.style.display = 'none';
            } else {
                almacenRow.style.display = 'none';
            }
        }

        // Cargar datos contables
        async function loadDatosContables() {
            try {
                const [tiposProducto, cuentasContables, tiposIVA, centrosCoste] = await Promise.all([
                    apiCall('/tipos-producto'),
                    apiCall('/cuentas-contables'),
                    apiCall('/tipos-iva'),
                    apiCall('/centros-coste')
                ]);

                currentData.tiposProducto = tiposProducto;
                currentData.cuentasContables = cuentasContables;
                currentData.tiposIVA = tiposIVA;
                currentData.centrosCoste = centrosCoste;
            } catch (error) {
                console.error('Error cargando datos contables:', error);
            }
        }

        // Cargar opciones para selects
        async function loadSelectOptions() {
            // Asegurar que los proveedores est√©n cargados
            if (!currentData.proveedores || currentData.proveedores.length === 0) {
                try {
                    currentData.proveedores = await apiCall('/proveedores');
                } catch (error) {
                    console.error('Error cargando proveedores:', error);
                    currentData.proveedores = [];
                }
            }

            // Asegurar que los productos est√©n cargados
            if (!currentData.productos || currentData.productos.length === 0) {
                try {
                    currentData.productos = await apiCall('/productos');
                } catch (error) {
                    console.error('Error cargando productos:', error);
                    currentData.productos = [];
                }
            }

            // Asegurar que los datos contables est√©n cargados
            if (!currentData.cuentasContables || currentData.cuentasContables.length === 0) {
                try {
                    currentData.cuentasContables = await apiCall('/cuentas-contables');
                } catch (error) {
                    console.error('Error cargando cuentas contables:', error);
                    currentData.cuentasContables = [];
                }
            }

            // Cargar proveedores en selects
            const selectsProveedores = document.querySelectorAll('#mapeo-proveedor, #stock-proveedor, #orden-proveedor, #factura-proveedor, #proveedor-archivo');
            selectsProveedores.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Seleccionar proveedor</option>';

                currentData.proveedores.forEach(proveedor => {
                    const option = document.createElement('option');
                    option.value = proveedor.id;
                    option.textContent = proveedor.nombre;
                    if (proveedor.id == currentValue) option.selected = true;
                    select.appendChild(option);
                });
            });

            // Cargar productos en selects
            const selectsProductos = document.querySelectorAll('#mapeo-producto, #stock-producto');
            selectsProductos.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Seleccionar producto</option>';

                currentData.productos.forEach(producto => {
                    const option = document.createElement('option');
                    option.value = producto.id;
                    option.textContent = `${producto.nombre} (${producto.codigo})`;
                    if (producto.id == currentValue) option.selected = true;
                    select.appendChild(option);
                });
            });

            // Cargar almacenes en selects
            const selectsAlmacenes = document.querySelectorAll('#stock-almacen-destino, #stock-almacen-origen');
            selectsAlmacenes.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Seleccionar almac√©n</option>';

                if (currentData.almacenes) {
                    currentData.almacenes.forEach(almacen => {
                        const option = document.createElement('option');
                        option.value = almacen.id;
                        option.textContent = almacen.nombre;
                        if (almacen.id == currentValue) option.selected = true;
                        select.appendChild(option);
                    });
                }
            });

            // Cargar √≥rdenes de compra pendientes para facturas y albaranes
            const selectOrdenesFactura = document.getElementById('factura-orden');
            const selectOrdenesAlbaran = document.getElementById('albaran-orden');
            [selectOrdenesFactura, selectOrdenesAlbaran].forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Seleccionar orden</option>';
                    if (currentData.ordenesCompra) {
                        currentData.ordenesCompra.filter(o => o.estado !== 'cancelada').forEach(orden => {
                            const option = document.createElement('option');
                            option.value = orden.id;
                            option.textContent = `${orden.numero_orden} - ${orden.proveedor_nombre}`;
                            select.appendChild(option);
                        });
                    }
                }
            });

            // Cargar datos contables en selects de productos
            const selectTipoProducto = document.getElementById('producto-tipo-producto');
            if (selectTipoProducto) {
                selectTipoProducto.innerHTML = '<option value="">Seleccionar tipo</option>';
                currentData.tiposProducto.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.id;
                    option.textContent = tipo.nombre;
                    selectTipoProducto.appendChild(option);
                });
            }

            const selectCuentaContable = document.getElementById('producto-cuenta-contable');
            if (selectCuentaContable) {
                selectCuentaContable.innerHTML = '<option value="">Seleccionar cuenta</option>';
                currentData.cuentasContables.forEach(cuenta => {
                    const option = document.createElement('option');
                    option.value = cuenta.id;
                    option.textContent = `${cuenta.codigo} - ${cuenta.nombre}`;
                    selectCuentaContable.appendChild(option);
                });
            }

            // Cargar cuenta contable para proveedores
            const selectCuentaContableProveedor = document.getElementById('proveedor-cuenta-contable');
            if (selectCuentaContableProveedor) {
                selectCuentaContableProveedor.innerHTML = '<option value="">Seleccionar cuenta contable</option>';
                currentData.cuentasContables.forEach(cuenta => {
                    const option = document.createElement('option');
                    option.value = cuenta.id;
                    option.textContent = `${cuenta.codigo} - ${cuenta.nombre}`;
                    selectCuentaContableProveedor.appendChild(option);
                });
            }

            const selectTipoIVA = document.getElementById('producto-tipo-iva');
            if (selectTipoIVA) {
                selectTipoIVA.innerHTML = '<option value="">Seleccionar IVA</option>';
                currentData.tiposIVA.forEach(iva => {
                    const option = document.createElement('option');
                    option.value = iva.id;
                    option.textContent = `${iva.nombre} (${iva.porcentaje}%)`;
                    selectTipoIVA.appendChild(option);
                });
            }

            const selectCentroCoste = document.getElementById('producto-centro-coste');
            if (selectCentroCoste) {
                selectCentroCoste.innerHTML = '<option value="">Seleccionar centro</option>';
                currentData.centrosCoste.forEach(centro => {
                    const option = document.createElement('option');
                    option.value = centro.id;
                    option.textContent = centro.nombre;
                    selectCentroCoste.appendChild(option);
                });
            }
        }

        // Almacenes
        async function loadAlmacenes() {
            try {
                const almacenes = await apiCall('/almacenes');
                currentData.almacenes = almacenes;
                renderAlmacenes();
            } catch (error) {
                document.getElementById('tabla-almacenes').innerHTML = `
                    <tr><td colspan="5" class="text-center text-muted">Error cargando almacenes</td></tr>
                `;
            }
        }

        function renderAlmacenes() {
            const tbody = document.getElementById('tabla-almacenes');

            if (currentData.almacenes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay almacenes registrados</td></tr>';
                return;
            }

            tbody.innerHTML = currentData.almacenes.map(almacen => `
                <tr>
                    <td>${almacen.id}</td>
                    <td>${almacen.nombre}</td>
                    <td>${almacen.ubicacion || '-'}</td>
                    <td>${almacen.descripcion || '-'}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="eliminarAlmacen(${almacen.id})">Borrar</button>
                    </td>
                </tr>
            `).join('');
        }

        document.getElementById('form-almacen').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                await apiCall('/almacenes', 'POST', data);
                showAlert('Almac√©n registrado exitosamente');
                e.target.reset();
                loadAlmacenes();
            } catch (error) {
                // Error ya mostrado en apiCall
            }
        });

        async function eliminarAlmacen(id) {
            if (confirm('¬øEst√°s seguro de eliminar este almac√©n?')) {
                try {
                    await apiCall(`/almacenes/${id}`, 'DELETE');
                    showAlert('Almac√©n eliminado exitosamente');
                    loadAlmacenes();
                } catch (error) {
                    // Error ya mostrado en apiCall
                }
            }
        }

        // ===============================
        //  INICIALIZA√á√ÉO DO SISTEMA
        // ===============================
        async function inicializarSistemaOrdenes() {
            try {
                // Carregar tabelas necess√°rias
                await Promise.all([
                    loadProveedores(),
                    loadProductos(),
                    loadMapeos()
                ]);

                // Mostrar tela principal
                mostrarEstadoInicial();
            } catch (error) {
                console.error('Error inicializando sistema de √≥rdenes:', error);
            }
        }

        // ===============================
        //  NOVO PEDIDO DE COMPRA
        // ===============================
        function abrirNuevoPedido() {
            // Criar objeto PEDIDO_TEMPORARIO
            PEDIDO_TEMPORARIO = {
                ordens: {}
            };

            // Mostrar tela de busca de produtos
            mostrarPantallaBusqueda();
        }

        // ===============================
        //  BUSCA E SELE√á√ÉO DE PRODUTOS
        // ===============================
        async function buscarProducto() {
            const termoBusca = document.getElementById('busqueda-producto').value.trim();

            if (!termoBusca) {
                showAlert('Por favor ingrese un t√©rmino de b√∫squeda', 'error');
                return;
            }

            // Verificar se os dados est√£o carregados
            if (!currentData.productos || currentData.productos.length === 0) {
                showAlert('Cargando datos del sistema, por favor espere...', 'error');
                return;
            }

            try {
                // Buscar produtos que coincidan
                const resultados = currentData.productos.filter(p =>
                    p.nombre.toLowerCase().includes(termoBusca.toLowerCase()) ||
                    (p.codigo && p.codigo.toLowerCase().includes(termoBusca.toLowerCase()))
                );

                if (resultados.length === 0) {
                    document.getElementById('resultados-busqueda').style.display = 'none';
                    showAlert('No se encontraron productos', 'error');
                    return;
                }

                // Para cada produto, buscar fornecedores e pre√ßos
                const resultadosComFornecedores = await Promise.all(
                    resultados.map(async (produto) => {
                        const fornecedores = await buscarFornecedoresProduto(produto.id);
                        return {
                            produto: produto,
                            fornecedores: fornecedores
                        };
                    })
                );

                mostrarResultadosBusca(resultadosComFornecedores);
                document.getElementById('resultados-busqueda').style.display = 'block';

            } catch (error) {
                showAlert('Error en la b√∫squeda', 'error');
                console.error(error);
            }
        }

        async function buscarFornecedoresProduto(produtoId) {
            try {
                // Verificar se os dados est√£o carregados
                if (!currentData.mapeos || !currentData.proveedores) {
                    console.warn('Dados de mapeos ou fornecedores n√£o carregados ainda');
                    return [];
                }

                // Buscar mapeos para este produto
                const mapeosProduto = currentData.mapeos.filter(m => m.producto_id === produtoId);

                const fornecedores = [];
                for (const mapeo of mapeosProduto) {
                    const fornecedor = currentData.proveedores.find(p => p.id === mapeo.proveedor_id);
                    if (fornecedor) {
                        // Buscar pre√ßo atual (simulado - em produ√ß√£o viria da API)
                        const preco = await buscarPreco(produtoId, mapeo.proveedor_id);
                        fornecedores.push({
                            fornecedor: fornecedor,
                            preco_unitario: preco || mapeo.factor_conversion || 0,
                            data_ultima_atualizacao: new Date().toISOString()
                        });
                    }
                }

                return fornecedores;
            } catch (error) {
                console.error('Error buscando fornecedores:', error);
                return [];
            }
        }

        function mostrarResultadosBusca(resultados) {
            const container = document.getElementById('lista-resultados');

            let html = '';
            resultados.forEach(resultado => {
                html += `
                    <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h5>${resultado.produto.nombre} (${resultado.produto.codigo})</h5>
                        <p style="color: #666; margin-bottom: 10px;">${resultado.produto.descripcion || ''}</p>
                `;

                if (resultado.fornecedores.length > 0) {
                    html += '<h6>Fornecedores disponibles:</h6>';
                    resultado.fornecedores.forEach(fornecedor => {
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; margin: 5px 0; border-radius: 4px;">
                                <div>
                                    <strong>${fornecedor.fornecedor.nombre}</strong><br>
                                    <small>Precio: ‚Ç¨${fornecedor.preco_unitario.toFixed(2)}</small>
                                </div>
                                <div>
                                    <input type="number" step="0.001" placeholder="Cantidad" id="qty-${resultado.produto.id}-${fornecedor.fornecedor.id}" style="width: 80px; margin-right: 10px;">
                                    <button class="btn btn-primary btn-sm" onclick="seleccionarProducto(${resultado.produto.id}, ${fornecedor.fornecedor.id})">
                                        Seleccionar
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #dc3545;">No hay proveedores disponibles para este producto.</p>';
                }

                html += '</div>';
            });

            container.innerHTML = html;
        }

        async function seleccionarProducto(produtoId, fornecedorId) {
            const quantidadeInput = document.getElementById(`qty-${produtoId}-${fornecedorId}`);
            const quantidade = parseFloat(quantidadeInput.value);

            if (!quantidade || quantidade <= 0) {
                showAlert('Por favor ingrese una cantidad v√°lida', 'error');
                return;
            }

            try {
                const fornecedor = await buscarFornecedor(fornecedorId);
                const produto = await buscarProdutoPorId(produtoId);
                const precoUnitario = await buscarPreco(produtoId, fornecedorId);

                // Verificar se j√° existe aba do fornecedor
                if (!PEDIDO_TEMPORARIO.ordens[fornecedorId]) {
                    criarAbaFornecedor(fornecedorId, fornecedor.nombre);
                    PEDIDO_TEMPORARIO.ordens[fornecedorId] = [];
                }

                // Adicionar item ao pedido do fornecedor
                PEDIDO_TEMPORARIO.ordens[fornecedorId].push({
                    produto_id: produtoId,
                    nome_produto: produto.nombre,
                    quantidade: quantidade,
                    preco_unitario: precoUnitario,
                    total: quantidade * precoUnitario
                });

                atualizarInterfaceAba(fornecedorId);

                // Limpar input e mostrar mensaje
                quantidadeInput.value = '';
                showAlert(`Producto agregado al pedido de ${fornecedor.nombre}`);

                // Mostrar interface de abas se √© a primeira sele√ß√£o
                if (Object.keys(PEDIDO_TEMPORARIO.ordens).length === 1) {
                    mostrarInterfaceAbas();
                }

            } catch (error) {
                showAlert('Error seleccionando producto', 'error');
                console.error(error);
            }
        }

        // ===============================
        //  INTERFACE DE ABAS POR FORNECEDOR
        // ===============================
        function criarAbaFornecedor(fornecedorId, nomeFornecedor) {
            const containerAbas = document.getElementById('contenedor-abas');
            const containerConteudo = document.getElementById('contenido-abas');

            // Criar bot√£o da aba
            const botaoAba = document.createElement('button');
            botaoAba.className = 'tab-button';
            botaoAba.id = `tab-${fornecedorId}`;
            botaoAba.textContent = nomeFornecedor;
            botaoAba.onclick = () => mostrarAba(fornecedorId);

            containerAbas.appendChild(botaoAba);

            // Criar conte√∫do da aba
            const conteudoAba = document.createElement('div');
            conteudoAba.className = 'tab-content';
            conteudoAba.id = `content-${fornecedorId}`;
            conteudoAba.innerHTML = `
                <h4>Productos para ${nomeFornecedor}</h4>
                <table class="supplier-products-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unit.</th>
                            <th>Total</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="items-${fornecedorId}"></tbody>
                </table>
                <div class="supplier-total" id="total-${fornecedorId}">
                    Subtotal: ‚Ç¨0.00
                </div>
            `;

            containerConteudo.appendChild(conteudoAba);
        }

        function mostrarAba(fornecedorId) {
            // Remover classe active de todas as abas
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Ativar aba selecionada
            document.getElementById(`tab-${fornecedorId}`).classList.add('active');
            document.getElementById(`content-${fornecedorId}`).classList.add('active');
        }

        function atualizarInterfaceAba(fornecedorId) {
            const items = PEDIDO_TEMPORARIO.ordens[fornecedorId];
            const tbody = document.getElementById(`items-${fornecedorId}`);
            const totalDiv = document.getElementById(`total-${fornecedorId}`);

            tbody.innerHTML = items.map((item, index) => `
                <tr>
                    <td>${item.nome_produto}</td>
                    <td>${item.quantidade}</td>
                    <td>‚Ç¨${item.preco_unitario.toFixed(2)}</td>
                    <td>‚Ç¨${item.total.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removerItem(${fornecedorId}, ${index})">Quitar</button>
                    </td>
                </tr>
            `).join('');

            const valorTotal = items.reduce((sum, item) => sum + item.total, 0);
            totalDiv.textContent = `Subtotal: ‚Ç¨${valorTotal.toFixed(2)}`;

            // Mostrar primeira aba se nenhuma estiver ativa
            if (!document.querySelector('.tab-button.active')) {
                mostrarAba(fornecedorId);
            }
        }

        function removerItem(fornecedorId, index) {
            PEDIDO_TEMPORARIO.ordens[fornecedorId].splice(index, 1);

            if (PEDIDO_TEMPORARIO.ordens[fornecedorId].length === 0) {
                // Remover aba se n√£o h√° mais items
                delete PEDIDO_TEMPORARIO.ordens[fornecedorId];
                document.getElementById(`tab-${fornecedorId}`).remove();
                document.getElementById(`content-${fornecedorId}`).remove();

                // Verificar se ainda h√° abas
                if (Object.keys(PEDIDO_TEMPORARIO.ordens).length === 0) {
                    mostrarEstadoInicial();
                } else {
                    // Mostrar primeira aba dispon√≠vel
                    const primeiraAba = Object.keys(PEDIDO_TEMPORARIO.ordens)[0];
                    mostrarAba(primeiraAba);
                }
            } else {
                atualizarInterfaceAba(fornecedorId);
            }
        }

        // ===============================
        //  GERA√á√ÉO DAS ORDENS DE COMPRA
        // ===============================
        async function gerarOrdenesCompra() {
            if (Object.keys(PEDIDO_TEMPORARIO.ordens).length === 0) {
                showAlert('No hay productos seleccionados', 'error');
                return;
            }

            try {
                const ordenesGeradas = [];

                for (const fornecedorId in PEDIDO_TEMPORARIO.ordens) {
                    const itens = PEDIDO_TEMPORARIO.ordens[fornecedorId];

                    // Convertir itens para o formato esperado pelo backend
                    const detalhes = [];
                    for (const item of itens) {
                        // Encontrar o mapeo_id para este produto e fornecedor
                        const mapeo = currentData.mapeos.find(m =>
                            m.producto_id === item.produto_id &&
                            m.proveedor_id === parseInt(fornecedorId)
                        );

                        if (mapeo) {
                            detalhes.push({
                                mapeo_id: mapeo.id,
                                cantidad_solicitada: item.quantidade,
                                precio_unitario: item.preco_unitario
                            });
                        }
                    }

                    if (detalhes.length === 0) {
                        showAlert(`No se encontraron mapeos para los productos del proveedor ${fornecedorId}`, 'error');
                        continue;
                    }

                    const ordemData = {
                        proveedor_id: parseInt(fornecedorId),
                        detalles: detalhes,
                        notas: `Orden generada autom√°ticamente - ${new Date().toLocaleDateString()}`
                    };

                    const result = await apiCall('/ordenes-compra', 'POST', ordemData);
                    ordenesGeradas.push(result);
                }

                showAlert(`√ìrdenes de compra generadas exitosamente! (${ordenesGeradas.length} √≥rdenes)`);

                // Limpar PEDIDO_TEMPORARIO
                PEDIDO_TEMPORARIO = { ordens: {} };

                // Recargar hist√≥rico
                loadOrdenesCompra();

                // Volver al estado inicial
                mostrarEstadoInicial();

            } catch (error) {
                showAlert('Error generando √≥rdenes de compra', 'error');
                console.error(error);
            }
        }

        // ===============================
        //  ATUALIZA√á√ÉO DE ESTOQUE
        // ===============================
        async function atualizarEstoqueRecebimento(idPedido) {
            try {
                const pedido = await apiCall(`/ordenes-compra/${idPedido}`);

                for (const item of pedido.itens) {
                    // Atualizar estoque (simulado - em produ√ß√£o seria uma chamada API)
                    await apiCall('/stock/movimiento', 'POST', {
                        producto_id: item.produto_id,
                        tipo_movimiento: 'entrada',
                        cantidad: item.quantidade,
                        precio_unitario: item.preco_unitario,
                        proveedor_id: pedido.fornecedor_id,
                        referencia: `Orden ${pedido.numero_orden}`,
                        motivo: 'Recepci√≥n de orden de compra'
                    });
                }

                // Marcar pedido como RECEBIDO
                await apiCall(`/ordenes-compra/${idPedido}/estado`, 'PUT', { estado: 'recibida' });

                showAlert('Estoque atualizado e pedido marcado como recibido');
                loadOrdenesCompra();
                loadDashboard();

            } catch (error) {
                showAlert('Error actualizando estoque', 'error');
                console.error(error);
            }
        }

        // ===============================
        //  FUN√á√ïES AUXILIARES
        // ===============================
        async function buscarFornecedor(id) {
            return currentData.proveedores.find(p => p.id === id) ||
                   await apiCall(`/proveedores/${id}`);
        }

        async function buscarProdutoPorId(id) {
            return currentData.productos.find(p => p.id === id) ||
                   await apiCall(`/productos/${id}`);
        }

        async function buscarPreco(produtoId, fornecedorId) {
            try {
                // Buscar em mapeos primeiro
                const mapeo = currentData.mapeos.find(m =>
                    m.producto_id === produtoId && m.proveedor_id === fornecedorId
                );

                if (mapeo && mapeo.factor_conversion) {
                    return mapeo.factor_conversion;
                }

                // Fallback: buscar pre√ßo na API (se existir endpoint)
                // Por ahora retornamos um pre√ßo simulado
                return Math.random() * 100 + 10; // Pre√ßo entre 10 e 110

            } catch (error) {
                console.error('Error buscando pre√ßo:', error);
                return 0;
            }
        }

        // Fun√ß√µes de navega√ß√£o entre estados
        function mostrarEstadoInicial() {
            document.getElementById('estado-inicial').style.display = 'block';
            document.getElementById('pantalla-busqueda').style.display = 'none';
            document.getElementById('interface-abas').style.display = 'none';
        }

        function mostrarPantallaBusqueda() {
            document.getElementById('estado-inicial').style.display = 'none';
            document.getElementById('pantalla-busqueda').style.display = 'block';
            document.getElementById('interface-abas').style.display = 'none';
            document.getElementById('busqueda-producto').focus();
        }

        function mostrarInterfaceAbas() {
            document.getElementById('estado-inicial').style.display = 'none';
            document.getElementById('pantalla-busqueda').style.display = 'none';
            document.getElementById('interface-abas').style.display = 'block';
        }

        function volverEstadoInicial() {
            // Limpar dados tempor√°rios
            PEDIDO_TEMPORARIO = { ordens: {} };
            document.getElementById('busqueda-producto').value = '';
            document.getElementById('resultados-busqueda').style.display = 'none';
            document.getElementById('contenedor-abas').innerHTML = '';
            document.getElementById('contenido-abas').innerHTML = '';
            mostrarEstadoInicial();
        }

        // √ìrdenes de Compra - Hist√≥rico
        async function loadOrdenesCompra() {
            try {
                const ordenes = await apiCall('/ordenes-compra');
                currentData.ordenesCompra = ordenes;
                renderOrdenesCompra();
            } catch (error) {
                document.getElementById('tabla-ordenes-compra').innerHTML = `
                    <tr><td colspan="6" class="text-center text-muted">Error cargando √≥rdenes</td></tr>
                `;
            }
        }

        function renderOrdenesCompra() {
            const tbody = document.getElementById('tabla-ordenes-compra');

            if (currentData.ordenesCompra.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay √≥rdenes de compra</td></tr>';
                return;
            }

            tbody.innerHTML = currentData.ordenesCompra.map(orden => `
                <tr>
                    <td>${orden.numero_orden}</td>
                    <td>${orden.proveedor_nombre}</td>
                    <td>${new Date(orden.fecha_creacion).toLocaleDateString()}</td>
                    <td><span class="badge ${getEstadoBadge(orden.estado)}">${orden.estado.replace('_', ' ').toUpperCase()}</span></td>
                    <td>‚Ç¨${orden.total ? orden.total.toFixed(2) : '0.00'}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="verOrdenCompra(${orden.id})">Ver</button>
                        ${orden.estado === 'PENDENTE' ? `<button class="btn btn-success btn-sm" onclick="atualizarEstoqueRecebimento(${orden.id})">Recibir</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function getEstadoBadge(estado) {
            const badges = {
                'PENDENTE': 'badge-medio',
                'ENVIADA': 'badge-ok',
                'RECIBIDA': 'badge-ok',
                'CANCELADA': 'badge-bajo'
            };
            return badges[estado] || 'badge-medio';
        }

        async function verOrdenCompra(id) {
            try {
                const orden = await apiCall(`/ordenes-compra/${id}`);
                let message = `Orden: ${orden.numero_orden}\nProveedor: ${orden.proveedor_nombre}\nTotal: ‚Ç¨${orden.total}\nEstado: ${orden.estado}\n\nItems:\n`;

                if (orden.itens && orden.itens.length > 0) {
                    orden.itens.forEach(item => {
                        message += `- ${item.nome_produto}: ${item.quantidade} x ‚Ç¨${item.preco_unitario} = ‚Ç¨${item.total}\n`;
                    });
                }

                alert(message);
            } catch (error) {
                showAlert('Error cargando orden de compra', 'error');
            }
        }

        // Facturas
        async function loadFacturas() {
            try {
                const facturas = await apiCall('/facturas');
                currentData.facturas = facturas;
                renderFacturas();
            } catch (error) {
                document.getElementById('tabla-facturas').innerHTML = `
                    <tr><td colspan="6" class="text-center text-muted">Error cargando facturas</td></tr>
                `;
            }
        }

        function renderFacturas() {
            const tbody = document.getElementById('tabla-facturas');

            if (currentData.facturas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay facturas registradas</td></tr>';
                return;
            }

            tbody.innerHTML = currentData.facturas.map(factura => `
                <tr>
                    <td>${factura.numero_factura}</td>
                    <td>${factura.proveedor_nombre}</td>
                    <td>${new Date(factura.fecha_emision).toLocaleDateString()}</td>
                    <td><span class="badge ${getFacturaEstadoBadge(factura.estado)}">${factura.estado.toUpperCase()}</span></td>
                    <td>${factura.total || 0}</td>
                    <td>
                        ${factura.estado === 'discrepancias' || factura.estado === 'verificada' ?
                            `<button class="btn btn-success btn-sm" onclick="aprobarFactura(${factura.id})">Aprobar</button>` : ''}
                        <button class="btn btn-secondary btn-sm" onclick="verFactura(${factura.id})">Ver</button>
                    </td>
                </tr>
            `).join('');
        }

        function getFacturaEstadoBadge(estado) {
            const badges = {
                'recibida': 'badge-medio',
                'procesando': 'badge-medio',
                'verificada': 'badge-ok',
                'discrepancias': 'badge-bajo',
                'aprobada': 'badge-ok'
            };
            return badges[estado] || 'badge-medio';
        }

        async function aprobarFactura(id) {
            const almacenId = prompt('Ingrese el ID del almac√©n donde se recibir√° la mercanc√≠a:');
            if (!almacenId) return;

            try {
                await apiCall(`/facturas/${id}/aprobar`, 'PUT', { almacen_id: parseInt(almacenId) });
                showAlert('Factura aprobada y stock actualizado');
                loadFacturas();
                loadDashboard();
            } catch (error) {
                // Error ya mostrado
            }
        }

        async function verFactura(id) {
            try {
                const factura = await apiCall(`/facturas/${id}`);
                alert(`Factura: ${factura.numero_factura}\nProveedor: ${factura.proveedor_nombre}\nTotal: ${factura.total}\nEstado: ${factura.estado}`);
            } catch (error) {
                showAlert('Error cargando factura', 'error');
            }
        }

        // Albaranes
        async function loadAlbaranes() {
            try {
                const albaranes = await apiCall('/albaranes-proveedores');
                currentData.albaranes = albaranes;
                renderAlbaranes();
            } catch (error) {
                document.getElementById('tabla-albaranes').innerHTML = `
                    <tr><td colspan="6" class="text-center text-muted">Error cargando albaranes</td></tr>
                `;
            }
        }

        function renderAlbaranes() {
            const tbody = document.getElementById('tabla-albaranes');

            if (currentData.albaranes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay albaranes registrados</td></tr>';
                return;
            }

            tbody.innerHTML = currentData.albaranes.map(albaran => `
                <tr>
                    <td>${albaran.numero_albaran}</td>
                    <td>${albaran.proveedor_nombre}</td>
                    <td>${new Date(albaran.fecha_recepcion).toLocaleDateString()}</td>
                    <td><span class="badge ${getAlbaranEstadoBadge(albaran.estado)}">${albaran.estado.toUpperCase()}</span></td>
                    <td>${albaran.total_items || 0}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="verAlbaran(${albaran.id})">Ver</button>
                        ${albaran.estado === 'recibido' ? `<button class="btn btn-primary btn-sm" onclick="procesarAlbaran(${albaran.id})">Procesar</button>` : ''}
                        ${albaran.estado === 'procesado' ? `<button class="btn btn-success btn-sm" onclick="completarAlbaran(${albaran.id})">Completar</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function getAlbaranEstadoBadge(estado) {
            const badges = {
                'recibido': 'badge-medio',
                'procesando': 'badge-medio',
                'procesado': 'badge-ok',
                'completado': 'badge-ok'
            };
            return badges[estado] || 'badge-medio';
        }

        async function verAlbaran(id) {
            try {
                const items = await apiCall(`/albaranes-proveedores/${id}/items`);
                let message = `Items del Albar√°n:\n\n`;
                items.forEach(item => {
                    message += `Producto: ${item.nombre_proveedor_crudo}\n`;
                    message += `Cantidad: ${item.cantidad_cruda}\n`;
                    message += `Precio: ${item.precio_unitario_crudo}\n`;
                    message += `Estado: ${item.estado}\n`;
                    if (item.producto_match) {
                        message += `Match: ${item.producto_match}\n`;
                    }
                    message += `---\n`;
                });
                alert(message);
            } catch (error) {
                showAlert('Error cargando items del albar√°n', 'error');
            }
        }

        async function procesarAlbaran(id) {
            if (confirm('¬øProcesar autom√°ticamente este albar√°n?')) {
                try {
                    const result = await apiCall(`/albaranes-proveedores/${id}/process`, 'POST');
                    showAlert(`Procesamiento completado. ${result.items_procesados} de ${result.total_items} items procesados.`);
                    loadAlbaranes();
                } catch (error) {
                    // Error ya mostrado
                }
            }
        }

        async function completarAlbaran(id) {
            if (confirm('¬øCompletar este albar√°n y actualizar inventario?')) {
                try {
                    const result = await apiCall(`/albaranes-proveedores/${id}/complete`, 'POST');
                    showAlert(`Albar√°n completado. ${result.items_procesados} items procesados e inventario actualizado.`);
                    loadAlbaranes();
                    loadDashboard();
                } catch (error) {
                    // Error ya mostrado
                }
            }
        }

        // Funciones auxiliares para √≥rdenes y facturas
        function agregarProductoOrden() {
            const container = document.getElementById('productos-orden');
            const index = container.children.length;

            const div = document.createElement('div');
            div.className = 'row';
            div.innerHTML = `
                <div class="col-2">
                    <select name="mapeo_id_${index}" required>
                        <option value="">Seleccionar producto</option>
                        ${currentData.mapeos.map(m => `<option value="${m.id}">${m.nombre_proveedor} (${m.proveedor_nombre})</option>`).join('')}
                    </select>
                </div>
                <div class="col-2">
                    <input type="number" step="0.001" name="cantidad_${index}" placeholder="Cantidad" required>
                    <input type="number" step="0.01" name="precio_${index}" placeholder="Precio unitario" required>
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">Quitar</button>
                </div>
            `;
            container.appendChild(div);
        }

        function agregarProductoFactura() {
            const container = document.getElementById('productos-factura');
            const index = container.children.length;

            const div = document.createElement('div');
            div.className = 'row';
            div.innerHTML = `
                <div class="col-2">
                    <select name="mapeo_id_${index}" required>
                        <option value="">Seleccionar producto</option>
                        ${currentData.mapeos.map(m => `<option value="${m.id}">${m.nombre_proveedor} (${m.proveedor_nombre})</option>`).join('')}
                    </select>
                </div>
                <div class="col-2">
                    <input type="number" step="0.001" name="cantidad_${index}" placeholder="Cantidad" required>
                    <input type="number" step="0.01" name="precio_${index}" placeholder="Precio unitario" required>
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">Quitar</button>
                </div>
            `;
            container.appendChild(div);
        }

        function agregarProductoAlbaran() {
            const container = document.getElementById('productos-albaran');
            const index = container.children.length;

            const div = document.createElement('div');
            div.className = 'row';
            div.innerHTML = `
                <div class="col-2">
                    <input type="text" name="nombre_${index}" placeholder="Nombre del producto" required>
                    <input type="text" name="codigo_${index}" placeholder="C√≥digo del producto">
                </div>
                <div class="col-2">
                    <input type="number" step="0.001" name="cantidad_${index}" placeholder="Cantidad" required>
                    <input type="number" step="0.01" name="precio_${index}" placeholder="Precio unitario" required>
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">Quitar</button>
                </div>
            `;
            container.appendChild(div);
        }

        // Funci√≥n para ver barcode
        function verBarcode(code) {
            window.open(`${API_BASE}/api/barcode/${code}`, '_blank');
        }

        // Actualizar loadModuleData para incluir nuevos m√≥dulos
        async function loadModuleData(moduleId) {
            switch(moduleId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'proveedores':
                    await loadProveedores();
                    await loadDatosContables();
                    await loadSelectOptions();
                    break;
                case 'productos':
                    await loadProductos();
                    await loadDatosContables();
                    await loadSelectOptions();
                    break;
                case 'medidas':
                    loadMedidas();
                    break;
                case 'mapeos':
                    loadMapeos();
                    await loadProveedores();
                    await loadProductos();
                    await loadSelectOptions();
                    break;
                case 'almacenes':
                    loadAlmacenes();
                    break;
                case 'ordenes-compra':
                    loadOrdenesCompra();
                    loadSelectOptions();
                    inicializarSistemaOrdenes();
                    break;
                case 'facturas':
                    loadFacturas();
                    loadSelectOptions();
                    break;
                case 'albaranes':
                    loadAlbaranes();
                    loadSelectOptions();
                    break;
                case 'stock':
                    loadMovimientosStock();
                    loadSelectOptions();
                    break;
                case 'contabilidad':
                    loadTiposProducto();
                    loadCuentasContables();
                    loadTiposIVA();
                    loadCentrosCoste();
                    showAccountingTab('tipos-producto');
                    break;
            }
        }

        // ===============================
        //  INICIALIZA√á√ÉO DO SISTEMA
        // ===============================
        async function inicializarSistemaOrdenes() {
            try {
                // Carregar tabelas necess√°rias
                await Promise.all([
                    loadProveedores(),
                    loadProductos(),
                    loadMapeos()
                ]);

                // Mostrar tela principal
                mostrarEstadoInicial();
            } catch (error) {
                console.error('Error inicializando sistema de √≥rdenes:', error);
            }
        }

        // ===============================
        //  NOVO PEDIDO DE COMPRA
        // ===============================
        function abrirNuevoPedido() {
            // Criar objeto PEDIDO_TEMPORARIO
            PEDIDO_TEMPORARIO = {
                ordens: {}
            };

            // Mostrar tela de busca de produtos
            mostrarPantallaBusqueda();
        }

        // ===============================
        //  BUSCA E SELE√á√ÉO DE PRODUTOS
        // ===============================
        async function buscarProducto() {
            const termoBusca = document.getElementById('busqueda-producto').value.trim();

            if (!termoBusca) {
                showAlert('Por favor ingrese un t√©rmino de b√∫squeda', 'error');
                return;
            }

            try {
                // Buscar produtos que coincidan
                const resultados = currentData.productos.filter(p =>
                    p.nombre.toLowerCase().includes(termoBusca.toLowerCase()) ||
                    (p.codigo && p.codigo.toLowerCase().includes(termoBusca.toLowerCase()))
                );

                if (resultados.length === 0) {
                    document.getElementById('resultados-busqueda').style.display = 'none';
                    showAlert('No se encontraron productos', 'error');
                    return;
                }

                // Para cada produto, buscar fornecedores e pre√ßos
                const resultadosComFornecedores = await Promise.all(
                    resultados.map(async (produto) => {
                        const fornecedores = await buscarFornecedoresProduto(produto.id);
                        return {
                            produto: produto,
                            fornecedores: fornecedores
                        };
                    })
                );

                mostrarResultadosBusca(resultadosComFornecedores);
                document.getElementById('resultados-busqueda').style.display = 'block';

            } catch (error) {
                showAlert('Error en la b√∫squeda', 'error');
                console.error(error);
            }
        }

        async function buscarFornecedoresProduto(produtoId) {
            try {
                // Buscar mapeos para este produto
                const mapeosProduto = currentData.mapeos.filter(m => m.producto_id === produtoId);

                const fornecedores = [];
                for (const mapeo of mapeosProduto) {
                    const fornecedor = currentData.proveedores.find(p => p.id === mapeo.proveedor_id);
                    if (fornecedor) {
                        // Buscar pre√ßo atual (simulado - em produ√ß√£o viria da API)
                        const preco = await buscarPreco(produtoId, mapeo.proveedor_id);
                        fornecedores.push({
                            fornecedor: fornecedor,
                            preco_unitario: preco || mapeo.factor_conversion || 0,
                            data_ultima_atualizacao: new Date().toISOString()
                        });
                    }
                }

                return fornecedores;
            } catch (error) {
                console.error('Error buscando fornecedores:', error);
                return [];
            }
        }

        function mostrarResultadosBusca(resultados) {
            const container = document.getElementById('lista-resultados');

            let html = '';
            resultados.forEach(resultado => {
                html += `
                    <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h5>${resultado.produto.nombre} (${resultado.produto.codigo})</h5>
                        <p style="color: #666; margin-bottom: 10px;">${resultado.produto.descripcion || ''}</p>
                `;

                if (resultado.fornecedores.length > 0) {
                    html += '<h6>Fornecedores disponibles:</h6>';
                    resultado.fornecedores.forEach(fornecedor => {
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; margin: 5px 0; border-radius: 4px;">
                                <div>
                                    <strong>${fornecedor.fornecedor.nombre}</strong><br>
                                    <small>Precio: ‚Ç¨${fornecedor.preco_unitario.toFixed(2)}</small>
                                </div>
                                <div>
                                    <input type="number" step="0.001" placeholder="Cantidad" id="qty-${resultado.produto.id}-${fornecedor.fornecedor.id}" style="width: 80px; margin-right: 10px;">
                                    <button class="btn btn-primary btn-sm" onclick="seleccionarProducto(${resultado.produto.id}, ${fornecedor.fornecedor.id})">
                                        Seleccionar
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #dc3545;">No hay proveedores disponibles para este producto.</p>';
                }

                html += '</div>';
            });

            container.innerHTML = html;
        }

        async function seleccionarProducto(produtoId, fornecedorId) {
            const quantidadeInput = document.getElementById(`qty-${produtoId}-${fornecedorId}`);
            const quantidade = parseFloat(quantidadeInput.value);

            if (!quantidade || quantidade <= 0) {
                showAlert('Por favor ingrese una cantidad v√°lida', 'error');
                return;
            }

            try {
                const fornecedor = await buscarFornecedor(fornecedorId);
                const produto = await buscarProdutoPorId(produtoId);
                const precoUnitario = await buscarPreco(produtoId, fornecedorId);

                // Verificar se j√° existe aba do fornecedor
                if (!PEDIDO_TEMPORARIO.ordens[fornecedorId]) {
                    criarAbaFornecedor(fornecedorId, fornecedor.nombre);
                    PEDIDO_TEMPORARIO.ordens[fornecedorId] = [];
                }

                // Adicionar item ao pedido do fornecedor
                PEDIDO_TEMPORARIO.ordens[fornecedorId].push({
                    produto_id: produtoId,
                    nome_produto: produto.nombre,
                    quantidade: quantidade,
                    preco_unitario: precoUnitario,
                    total: quantidade * precoUnitario
                });

                atualizarInterfaceAba(fornecedorId);

                // Limpar input e mostrar mensaje
                quantidadeInput.value = '';
                showAlert(`Producto agregado al pedido de ${fornecedor.nombre}`);

                // Mostrar interface de abas se √© a primeira sele√ß√£o
                if (Object.keys(PEDIDO_TEMPORARIO.ordens).length === 1) {
                    mostrarInterfaceAbas();
                }

            } catch (error) {
                showAlert('Error seleccionando producto', 'error');
                console.error(error);
            }
        }

        // ===============================
        //  INTERFACE DE ABAS POR FORNECEDOR
        // ===============================
        function criarAbaFornecedor(fornecedorId, nomeFornecedor) {
            const containerAbas = document.getElementById('contenedor-abas');
            const containerConteudo = document.getElementById('contenido-abas');

            // Criar bot√£o da aba
            const botaoAba = document.createElement('button');
            botaoAba.className = 'tab-button';
            botaoAba.id = `tab-${fornecedorId}`;
            botaoAba.textContent = nomeFornecedor;
            botaoAba.onclick = () => mostrarAba(fornecedorId);

            containerAbas.appendChild(botaoAba);

            // Criar conte√∫do da aba
            const conteudoAba = document.createElement('div');
            conteudoAba.className = 'tab-content';
            conteudoAba.id = `content-${fornecedorId}`;
            conteudoAba.innerHTML = `
                <h4>Productos para ${nomeFornecedor}</h4>
                <table class="supplier-products-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unit.</th>
                            <th>Total</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="items-${fornecedorId}"></tbody>
                </table>
                <div class="supplier-total" id="total-${fornecedorId}">
                    Subtotal: ‚Ç¨0.00
                </div>
            `;

            containerConteudo.appendChild(conteudoAba);
        }

        function mostrarAba(fornecedorId) {
            // Remover classe active de todas as abas
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Ativar aba selecionada
            document.getElementById(`tab-${fornecedorId}`).classList.add('active');
            document.getElementById(`content-${fornecedorId}`).classList.add('active');
        }

        function atualizarInterfaceAba(fornecedorId) {
            const items = PEDIDO_TEMPORARIO.ordens[fornecedorId];
            const tbody = document.getElementById(`items-${fornecedorId}`);
            const totalDiv = document.getElementById(`total-${fornecedorId}`);

            tbody.innerHTML = items.map((item, index) => `
                <tr>
                    <td>${item.nome_produto}</td>
                    <td>${item.quantidade}</td>
                    <td>‚Ç¨${item.preco_unitario.toFixed(2)}</td>
                    <td>‚Ç¨${item.total.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removerItem(${fornecedorId}, ${index})">Quitar</button>
                    </td>
                </tr>
            `).join('');

            const valorTotal = items.reduce((sum, item) => sum + item.total, 0);
            totalDiv.textContent = `Subtotal: ‚Ç¨${valorTotal.toFixed(2)}`;

            // Mostrar primeira aba se nenhuma estiver ativa
            if (!document.querySelector('.tab-button.active')) {
                mostrarAba(fornecedorId);
            }
        }

        function removerItem(fornecedorId, index) {
            PEDIDO_TEMPORARIO.ordens[fornecedorId].splice(index, 1);

            if (PEDIDO_TEMPORARIO.ordens[fornecedorId].length === 0) {
                // Remover aba se n√£o h√° mais items
                delete PEDIDO_TEMPORARIO.ordens[fornecedorId];
                document.getElementById(`tab-${fornecedorId}`).remove();
                document.getElementById(`content-${fornecedorId}`).remove();

                // Verificar se ainda h√° abas
                if (Object.keys(PEDIDO_TEMPORARIO.ordens).length === 0) {
                    mostrarEstadoInicial();
                } else {
                    // Mostrar primeira aba dispon√≠vel
                    const primeiraAba = Object.keys(PEDIDO_TEMPORARIO.ordens)[0];
                    mostrarAba(primeiraAba);
                }
            } else {
                atualizarInterfaceAba(fornecedorId);
            }
        }

        // ===============================
        //  GERA√á√ÉO DAS ORDENS DE COMPRA
        // ===============================
        async function gerarOrdenesCompra() {
            if (Object.keys(PEDIDO_TEMPORARIO.ordens).length === 0) {
                showAlert('No hay productos seleccionados', 'error');
                return;
            }

            try {
                const ordenesGeradas = [];

                for (const fornecedorId in PEDIDO_TEMPORARIO.ordens) {
                    const itens = PEDIDO_TEMPORARIO.ordens[fornecedorId];
                    const valorTotal = itens.reduce((sum, item) => sum + item.total, 0);

                    const ordemData = {
                        fornecedor_id: parseInt(fornecedorId),
                        data_criacao: new Date().toISOString(),
                        valor_total: valorTotal,
                        status: 'PENDENTE',
                        itens: itens
                    };

                    const result = await apiCall('/ordenes-compra', 'POST', ordemData);
                    ordenesGeradas.push(result);
                }

                showAlert(`√ìrdenes de compra generadas exitosamente! (${ordenesGeradas.length} √≥rdenes)`);

                // Limpar PEDIDO_TEMPORARIO
                PEDIDO_TEMPORARIO = { ordens: {} };

                // Recargar hist√≥rico
                loadOrdenesCompra();

                // Volver al estado inicial
                mostrarEstadoInicial();

            } catch (error) {
                showAlert('Error generando √≥rdenes de compra', 'error');
                console.error(error);
            }
        }

        // ===============================
        //  ATUALIZA√á√ÉO DE ESTOQUE
        // ===============================
        async function atualizarEstoqueRecebimento(idPedido) {
            try {
                const pedido = await apiCall(`/ordenes-compra/${idPedido}`);

                for (const item of pedido.itens) {
                    // Atualizar estoque (simulado - em produ√ß√£o seria uma chamada API)
                    await apiCall('/stock/movimiento', 'POST', {
                        producto_id: item.produto_id,
                        tipo_movimiento: 'entrada',
                        cantidad: item.quantidade,
                        precio_unitario: item.preco_unitario,
                        proveedor_id: pedido.fornecedor_id,
                        referencia: `Orden ${pedido.numero_orden}`,
                        motivo: 'Recepci√≥n de orden de compra'
                    });
                }

                // Marcar pedido como RECEBIDO
                await apiCall(`/ordenes-compra/${idPedido}/estado`, 'PUT', { estado: 'recibida' });

                showAlert('Estoque atualizado e pedido marcado como recibido');
                loadOrdenesCompra();
                loadDashboard();

            } catch (error) {
                showAlert('Error actualizando estoque', 'error');
                console.error(error);
            }
        }

        // ===============================
        //  FUN√á√ïES AUXILIARES
        // ===============================
        async function buscarFornecedor(id) {
            return currentData.proveedores.find(p => p.id === id) ||
                   await apiCall(`/proveedores/${id}`);
        }

        async function buscarProdutoPorId(id) {
            return currentData.productos.find(p => p.id === id) ||
                   await apiCall(`/productos/${id}`);
        }

        async function buscarPreco(produtoId, fornecedorId) {
            try {
                // Buscar em mapeos primeiro
                const mapeo = currentData.mapeos.find(m =>
                    m.producto_id === produtoId && m.proveedor_id === fornecedorId
                );

                if (mapeo && mapeo.factor_conversion) {
                    return mapeo.factor_conversion;
                }

                // Fallback: buscar pre√ßo na API (se existir endpoint)
                // Por ahora retornamos um pre√ßo simulado
                return Math.random() * 100 + 10; // Pre√ßo entre 10 e 110

            } catch (error) {
                console.error('Error buscando pre√ßo:', error);
                return 0;
            }
        }

        // Fun√ß√µes de navega√ß√£o entre estados
        function mostrarEstadoInicial() {
            document.getElementById('estado-inicial').style.display = 'block';
            document.getElementById('pantalla-busqueda').style.display = 'none';
            document.getElementById('interface-abas').style.display = 'none';
        }

        function mostrarPantallaBusqueda() {
            document.getElementById('estado-inicial').style.display = 'none';
            document.getElementById('pantalla-busqueda').style.display = 'block';
            document.getElementById('interface-abas').style.display = 'none';
            document.getElementById('busqueda-producto').focus();
        }

        function mostrarInterfaceAbas() {
            document.getElementById('estado-inicial').style.display = 'none';
            document.getElementById('pantalla-busqueda').style.display = 'none';
            document.getElementById('interface-abas').style.display = 'block';
        }

        function volverEstadoInicial() {
            // Limpar dados tempor√°rios
            PEDIDO_TEMPORARIO = { ordens: {} };
            document.getElementById('busqueda-producto').value = '';
            document.getElementById('resultados-busqueda').style.display = 'none';
            document.getElementById('contenedor-abas').innerHTML = '';
            document.getElementById('contenido-abas').innerHTML = '';
            mostrarEstadoInicial();
        }

        // Form handlers para facturas
        document.getElementById('form-factura').addEventListener('submit', async (e) => {
            e.preventDefault();

            const detalles = [];
            const productosContainer = document.getElementById('productos-factura');
            const inputs = productosContainer.querySelectorAll('input[name*="cantidad_"], input[name*="precio_"]');

            for (let i = 0; i < inputs.length; i += 2) {
                const cantidad = parseFloat(inputs[i].value);
                const precio = parseFloat(inputs[i + 1].value);
                const mapeoId = inputs[i].closest('.row').querySelector('select').value;

                if (cantidad > 0 && precio > 0 && mapeoId) {
                    detalles.push({
                        mapeo_id: parseInt(mapeoId),
                        cantidad: cantidad,
                        precio_unitario: precio
                    });
                }
            }

            const formData = new FormData(e.target);
            const data = {
                ...Object.fromEntries(formData),
                detalles: detalles
            };

            try {
                const result = await apiCall('/facturas', 'POST', data);
                showAlert(`Factura registrada exitosamente. Estado: ${result.estado}`);
                e.target.reset();
                document.getElementById('productos-factura').innerHTML = '';
                loadFacturas();
            } catch (error) {
                // Error ya mostrado
            }
        });

        // Form handlers para albaranes
        document.getElementById('form-albaran').addEventListener('submit', async (e) => {
            e.preventDefault();

            const detalles = [];
            const productosContainer = document.getElementById('productos-albaran');
            const rows = productosContainer.querySelectorAll('.row');

            rows.forEach(row => {
                const nombre = row.querySelector('input[name*="nombre_"]').value;
                const codigo = row.querySelector('input[name*="codigo_"]').value;
                const cantidad = parseFloat(row.querySelector('input[name*="cantidad_"]').value);
                const precio = parseFloat(row.querySelector('input[name*="precio_"]').value);

                if (nombre && cantidad > 0 && precio > 0) {
                    detalles.push({
                        nombre_proveedor: nombre,
                        codigo_proveedor: codigo,
                        cantidad: cantidad,
                        precio_unitario: precio
                    });
                }
            });

            const formData = new FormData(e.target);
            const data = {
                ...Object.fromEntries(formData),
                items: detalles
            };

            try {
                const result = await apiCall('/albaranes-proveedores', 'POST', data);
                showAlert('Albar√°n registrado exitosamente. Procesamiento autom√°tico iniciado.');
                e.target.reset();
                document.getElementById('productos-albaran').innerHTML = '';
                loadAlbaranes();
            } catch (error) {
                // Error ya mostrado
            }
        });

        // ==================== CONTABILIDAD FUNCTIONS ====================

        // Mostrar pesta√±a de contabilidad
        function showAccountingTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.accounting-tab').forEach(tab => {
                tab.style.display = 'none';
            });

            // Mostrar la pesta√±a seleccionada
            document.getElementById('tab-' + tabName).style.display = 'block';

            // Actualizar botones activos
            document.querySelectorAll('.accounting-tab-buttons button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Tipos de Producto
        async function loadTiposProducto() {
            try {
                const tipos = await apiCall('/tipos-producto');
                renderTiposProducto(tipos);
            } catch (error) {
                document.getElementById('tabla-tipos-producto').innerHTML = `
                    <tr><td colspan="4" class="text-center text-muted">Error cargando tipos de producto</td></tr>
                `;
            }
        }

        function renderTiposProducto(tipos) {
            const tbody = document.getElementById('tabla-tipos-producto');

            if (tipos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No hay tipos de producto registrados</td></tr>';
                return;
            }

            tbody.innerHTML = tipos.map(tipo => `
                <tr>
                    <td>${tipo.id}</td>
                    <td>${tipo.nombre}</td>
                    <td>${tipo.descripcion || '-'}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="eliminarTipoProducto(${tipo.id})">Borrar</button>
                    </td>
                </tr>
            `).join('');
        }

        async function eliminarTipoProducto(id) {
            if (confirm('¬øEst√°s seguro de eliminar este tipo de producto?')) {
                try {
                    await apiCall(`/tipos-producto/${id}`, 'DELETE');
                    showAlert('Tipo de producto eliminado exitosamente');
                    loadTiposProducto();
                } catch (error) {
                    // Error ya mostrado
                }
            }
        }

        // Cuentas Contables
        async function loadCuentasContables() {
            try {
                const cuentas = await apiCall('/cuentas-contables');
                renderCuentasContables(cuentas);
            } catch (error) {
                document.getElementById('tabla-cuentas-contables').innerHTML = `
                    <tr><td colspan="5" class="text-center text-muted">Error cargando cuentas contables</td></tr>
                `;
            }
        }

        function renderCuentasContables(cuentas) {
            const tbody = document.getElementById('tabla-cuentas-contables');

            if (cuentas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay cuentas contables registradas</td></tr>';
                return;
            }

            tbody.innerHTML = cuentas.map(cuenta => `
                <tr>
                    <td>${cuenta.id}</td>
                    <td>${cuenta.codigo}</td>
                    <td>${cuenta.nombre}</td>
                    <td>${cuenta.descripcion || '-'}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="eliminarCuentaContable(${cuenta.id})">Borrar</button>
                    </td>
                </tr>
            `).join('');
        }

        async function eliminarCuentaContable(id) {
            if (confirm('¬øEst√°s seguro de eliminar esta cuenta contable?')) {
                try {
                    await apiCall(`/cuentas-contables/${id}`, 'DELETE');
                    showAlert('Cuenta contable eliminada exitosamente');
                    loadCuentasContables();
                } catch (error) {
                    // Error ya mostrado
                }
            }
        }

        // Importar cuentas desde Excel
        async function importarCuentasExcel() {
            const fileInput = document.getElementById('excel-file');
            const file = fileInput.files[0];

            if (!file) {
                showAlert('Por favor selecciona un archivo Excel', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('excel', file);

            try {
                const result = await fetch(`${API_BASE}/api/cuentas-contables/importar-excel`, {
                    method: 'POST',
                    body: formData
                });

                const data = await result.json();

                if (!result.ok) {
                    throw new Error(data.error || 'Error importando archivo');
                }

                showAlert(`Importaci√≥n completada. ${data.importados} cuentas importadas.`);
                loadCuentasContables();
                fileInput.value = ''; // Limpiar input
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        // Tipos de IVA
        async function loadTiposIVA() {
            try {
                const tiposIVA = await apiCall('/tipos-iva');
                renderTiposIVA(tiposIVA);
            } catch (error) {
                document.getElementById('tabla-tipos-iva').innerHTML = `
                    <tr><td colspan="5" class="text-center text-muted">Error cargando tipos de IVA</td></tr>
                `;
            }
        }

        function renderTiposIVA(tiposIVA) {
            const tbody = document.getElementById('tabla-tipos-iva');

            if (tiposIVA.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay tipos de IVA registrados</td></tr>';
                return;
            }

            tbody.innerHTML = tiposIVA.map(iva => `
                <tr>
                    <td>${iva.id}</td>
                    <td>${iva.porcentaje}%</td>
                    <td>${iva.nombre || '-'}</td>
                    <td>${iva.descripcion || '-'}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="eliminarTipoIVA(${iva.id})">Borrar</button>
                    </td>
                </tr>
            `).join('');
        }

        async function eliminarTipoIVA(id) {
            if (confirm('¬øEst√°s seguro de eliminar este tipo de IVA?')) {
                try {
                    await apiCall(`/tipos-iva/${id}`, 'DELETE');
                    showAlert('Tipo de IVA eliminado exitosamente');
                    loadTiposIVA();
                } catch (error) {
                    // Error ya mostrado
                }
            }
        }

        // Centros de Coste
        async function loadCentrosCoste() {
            try {
                const centros = await apiCall('/centros-coste');
                renderCentrosCoste(centros);
            } catch (error) {
                document.getElementById('tabla-centros-coste').innerHTML = `
                    <tr><td colspan="4" class="text-center text-muted">Error cargando centros de coste</td></tr>
                `;
            }
        }

        function renderCentrosCoste(centros) {
            const tbody = document.getElementById('tabla-centros-coste');

            if (centros.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No hay centros de coste registrados</td></tr>';
                return;
            }

            tbody.innerHTML = centros.map(centro => `
                <tr>
                    <td>${centro.id}</td>
                    <td>${centro.nombre}</td>
                    <td>${centro.descripcion || '-'}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="eliminarCentroCoste(${centro.id})">Borrar</button>
                    </td>
                </tr>
            `).join('');
        }

        async function eliminarCentroCoste(id) {
            if (confirm('¬øEst√°s seguro de eliminar este centro de coste?')) {
                try {
                    await apiCall(`/centros-coste/${id}`, 'DELETE');
                    showAlert('Centro de coste eliminado exitosamente');
                    loadCentrosCoste();
                } catch (error) {
                    // Error ya mostrado
                }
            }
        }

        // Configuraci√≥n del Hotel
        async function loadConfiguracionHotel() {
            try {
                const config = await apiCall('/configuracion-hotel');

                // Llenar el formulario con los datos existentes
                document.getElementById('hotel-nombre-legal').value = config.nombre_legal || '';
                document.getElementById('hotel-nombre-social').value = config.nombre_social || '';
                document.getElementById('hotel-direccion').value = config.direccion || '';
                document.getElementById('hotel-ciudad').value = config.ciudad || '';
                document.getElementById('hotel-codigo-postal').value = config.codigo_postal || '';
                document.getElementById('hotel-nif').value = config.nif || '';
                document.getElementById('hotel-telefono').value = config.telefono || '';
                document.getElementById('hotel-email').value = config.email_contacto || '';

            } catch (error) {
                console.error('Error cargando configuraci√≥n del hotel:', error);
                showAlert('Error cargando configuraci√≥n del hotel', 'error');
            }
        }

        // Form handler para configuraci√≥n del hotel
        document.getElementById('form-configuracion-hotel').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                await apiCall('/configuracion-hotel', 'POST', data);
                showAlert('Configuraci√≥n del hotel guardada exitosamente');
            } catch (error) {
                // Error ya mostrado en apiCall
            }
        });

        // Form handlers para contabilidad
        document.getElementById('form-tipo-producto').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                await apiCall('/tipos-producto', 'POST', data);
                showAlert('Tipo de producto registrado exitosamente');
                e.target.reset();
                loadTiposProducto();
            } catch (error) {
                // Error ya mostrado
            }
        });

        document.getElementById('form-cuenta-contable').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                await apiCall('/cuentas-contables', 'POST', data);
                showAlert('Cuenta contable registrada exitosamente');
                e.target.reset();
                loadCuentasContables();
            } catch (error) {
                // Error ya mostrado
            }
        });

        document.getElementById('form-tipo-iva').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                await apiCall('/tipos-iva', 'POST', data);
                showAlert('Tipo de IVA registrado exitosamente');
                e.target.reset();
                loadTiposIVA();
            } catch (error) {
                // Error ya mostrado
            }
        });

        document.getElementById('form-centro-coste').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                await apiCall('/centros-coste', 'POST', data);
                showAlert('Centro de coste registrado exitosamente');
                e.target.reset();
                loadCentrosCoste();
            } catch (error) {
                // Error ya mostrado
            }
        });

        // Event listeners adicionales
        document.getElementById('buscar-productos').addEventListener('input', filtrarProductos);

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            loadMedidas(); // Cargar medidas para los selects
        });
    </script>
</body>
</html>
